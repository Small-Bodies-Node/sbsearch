#include "config.h"

#include <vector>
#include <gtest/gtest.h>
#include <s2/s2latlng.h>

#include "ephemeris.h"
#include "moving_target.h"
#include "observatory.h"
#include "util.h"

using std::string;

namespace sbsearch
{
    namespace testing
    {
        const Ephemeris horizons_to_ephemeris(const string &horizons_table)
        {
            Ephemeris::Data data;
            bool table_content = false;
            for (const string &line : split(horizons_table, '\n'))
            {
                if (line == "$$EOE")
                    break;

                if (table_content)
                {
                    const vector<string> columns = split(line, ',');
                    data.push_back({.mjd = std::stod(columns[0]) - 2400000.5,
                                    .ra = std::stod(columns[3]),
                                    .dec = std::stod(columns[4]),
                                    .delta = std::stod(columns[19])});
                }

                if (line == "$$SOE")
                    table_content = true;
            }
            Ephemeris eph{MovingTarget(), data};
            return eph;
        }

        TEST(ObservatoryTests, ObservatoryMars)
        {
            // Meeus example 40a
            Observatory palomar{-(7 + 47. / 60 + 27. / 3600) * 15, 0.836339, 0.546861};
            S2LatLng mars = S2LatLng::FromDegrees(-15.7710833333, 339.53020833333); // apparent Dec, RA
            S2LatLng coords = palomar.parallax(mars, 52879.13680555556, 0.37276);
            EXPECT_NEAR(coords.lng().degrees(), (22 + 38. / 60 + 8.54 / 3600) * 15, 4 * ARCSEC);
            EXPECT_NEAR(coords.lat().degrees(), -(15 + 46. / 60 + 30.0 / 3600), 3 * ARCSEC);
        }

        TEST(ObservatoryTests, ObservatoryHartley2)
        {
            // Astrometric ephemeris for Hartley 2, 24 hour period starting 2010 Oct 1 at LDT
            vector<vector<double>> ephemeris_obs = {{2455470.500000000, 10.472347936, 55.031215755, 0.18417361441047},
                                                    {2455470.541666667, 10.577003772, 55.054297704, 0.18394075762819},
                                                    {2455470.583333333, 10.680740819, 55.077392096, 0.18370797528808},
                                                    {2455470.625000000, 10.783552925, 55.100340543, 0.18347562045185},
                                                    {2455470.666666667, 10.885520820, 55.122989008, 0.18324403355769},
                                                    {2455470.708333333, 10.986807086, 55.145198203, 0.18301351948325},
                                                    {2455470.750000000, 11.087645526, 55.166853042, 0.18278432703335},
                                                    {2455470.791666667, 11.188325638, 55.187870469, 0.18255663223752},
                                                    {2455470.833333333, 11.289173221, 55.208205154, 0.18233052658407},
                                                    {2455470.875000000, 11.390528427, 55.227852624, 0.18210601098197},
                                                    {2455470.916666667, 11.492722753, 55.246849631, 0.18188299585280},
                                                    {2455470.958333333, 11.596056556, 55.265271709, 0.18166130733872},
                                                    {2455471.000000000, 11.700778626, 55.283228091, 0.18144069919759},
                                                    {2455471.041666667, 11.807069231, 55.300854315, 0.18122086957160},
                                                    {2455471.083333333, 11.915027790, 55.318303051, 0.18100148148755},
                                                    {2455471.125000000, 12.024666001, 55.335733740, 0.18078218569677},
                                                    {2455471.166666667, 12.135906913, 55.353301768, 0.18056264430844},
                                                    {2455471.208333333, 12.248589968, 55.371147908, 0.18034255362005},
                                                    {2455471.250000000, 12.362481698, 55.389388722, 0.18012166460761},
                                                    {2455471.291666667, 12.477291336, 55.408108595, 0.17989979969904},
                                                    {2455471.333333333, 12.592690318, 55.427353905, 0.17967686470794},
                                                    {2455471.375000000, 12.708334360, 55.447129742, 0.17945285513194},
                                                    {2455471.416666667, 12.823886660, 55.467399399, 0.17922785640023},
                                                    {2455471.458333333, 12.939040676, 55.488086657, 0.17900203806123},
                                                    {2455471.500000000, 13.053540963, 55.509080744, 0.17877564230828}};

            vector<vector<double>> ephemeris_geo = {{2455470.500000000, 10.454737412, 55.038928622, 0.18418578033653},
                                                    {2455470.541666667, 10.558082802, 55.059766962, 0.18395797236107},
                                                    {2455470.583333333, 10.661785490, 55.080532093, 0.18373040987549},
                                                    {2455470.625000000, 10.765846373, 55.101223249, 0.18350309353657},
                                                    {2455470.666666667, 10.870266340, 55.121839655, 0.18327602400408},
                                                    {2455470.708333333, 10.975046280, 55.142380533, 0.18304920194081},
                                                    {2455470.750000000, 11.080187072, 55.162845098, 0.18282262801256},
                                                    {2455470.791666667, 11.185689592, 55.183232562, 0.18259630288816},
                                                    {2455470.833333333, 11.291554710, 55.203542127, 0.18237022723948},
                                                    {2455470.875000000, 11.397783290, 55.223772995, 0.18214440174140},
                                                    {2455470.916666667, 11.504376191, 55.243924359, 0.18191882707189},
                                                    {2455470.958333333, 11.611334266, 55.263995406, 0.18169350391193},
                                                    {2455471.000000000, 11.718658360, 55.283985321, 0.18146843294560},
                                                    {2455471.041666667, 11.826349314, 55.303893279, 0.18124361486000},
                                                    {2455471.083333333, 11.934407962, 55.323718454, 0.18101905034535},
                                                    {2455471.125000000, 12.042835130, 55.343460010, 0.18079474009491},
                                                    {2455471.166666667, 12.151631641, 55.363117108, 0.18057068480507},
                                                    {2455471.208333333, 12.260798306, 55.382688903, 0.18034688517527},
                                                    {2455471.250000000, 12.370335934, 55.402174545, 0.18012334190809},
                                                    {2455471.291666667, 12.480245323, 55.421573176, 0.17990005570917},
                                                    {2455471.333333333, 12.590527266, 55.440883935, 0.17967702728732},
                                                    {2455471.375000000, 12.701182548, 55.460105955, 0.17945425735441},
                                                    {2455471.416666667, 12.812211946, 55.479238360, 0.17923174662549},
                                                    {2455471.458333333, 12.923616230, 55.498280274, 0.17900949581870},
                                                    {2455471.500000000, 13.035396161, 55.517230810, 0.17878750565534}};

            Observatory obs{248.57749, 0.822887, 0.566916}; // Lowell Discovery Telescope (G37)
            for (int i = 0; i < ephemeris_obs.size(); i++)
            {
                S2LatLng coords_geo = S2LatLng::FromDegrees(ephemeris_geo[i][2], ephemeris_geo[i][1]);
                S2LatLng coords_obs = S2LatLng::FromDegrees(ephemeris_obs[i][2], ephemeris_obs[i][1]);
                S2LatLng coords = obs.parallax(coords_geo, ephemeris_geo[i][0] - 2400000.5, ephemeris_geo[i][3]);
                EXPECT_NEAR(coords.lng().radians(), coords_obs.lng().radians(), 0.1 * ARCSEC);
                EXPECT_NEAR(coords.lat().radians(), coords_obs.lat().radians(), 0.1 * ARCSEC);
            }
        }

        TEST(ObservatoryTests, Observatory74PParallax)
        {
            const string table_geo = R"(
*******************************************************************************
JPL/HORIZONS                74P/Smirnova-Chernykh          2023-Mar-24 06:04:43
Rec #:90000817 (+COV) Soln.date: 2023-Jan-23_00:02:38   # obs: 5844 (1997-2023)
 
IAU76/J2000 helio. ecliptic osc. elements (au, days, deg., period=Julian yrs):
 
  EPOCH=  2456199.5 ! 2012-Sep-29.0000000 (TDB)    RMSW= n.a.
   EC= .1476581394100441   QR= 3.550719336771267   TP= 2455039.2047568592
   OM= 77.08403534654171   W= 86.5924648418255     IN= 6.651025247302388
   A= 4.165839437140405    MA= 134.4989194000786   ADIST= 4.780959537509543
   PER= 8.5028005667983    N= .115917841           ANGMOM= .03472529
   DAN= 4.03956            DDN= 4.11109            L= 163.6534671
   B= 6.6392134            MOID= 2.56964993        TP= 2009-Jul-26.7047568592
 
Comet physical (GM= km^3/s^2; RAD= km):
   GM= n.a.                RAD= 2.23
   M1=  6.7      M2=  12.1     k1=  14.    k2=  5.      PHCOF=  .030
 
Comet non-gravitational force model (AMRAT=m^2/kg;A1-A3=au/d^2;DT=days;R0=au):
   AMRAT=  0.                                      DT=  0.
   A1= 2.011297035217E-7   A2= -9.918458938599E-8  A3= 0.
 Standard model:
   ALN=  .1112620426   NK=  4.6142   NM=  2.15     NN=  5.093    R0=  2.808
 
COMET comments 
1: soln ref.= JPL#K183/41, data arc: 1997-07-14 to 2023-01-09
2: k1=14., k2=5., phase coef.=0.03;
*******************************************************************************


*******************************************************************************
Ephemeris / WWW_USER Fri Mar 24 06:04:43 2023 Pasadena, USA      / Horizons    
*******************************************************************************
Target body name: 74P/Smirnova-Chernykh           {source: JPL#K183/41}
Center body name: Earth (399)                     {source: DE441}
Center-site name: GEOCENTRIC
*******************************************************************************
Start time      : A.D. 2020-Oct-01 00:00:00.0000 UT      
Stop  time      : A.D. 2020-Oct-02 00:00:00.0000 UT      
Step-size       : 60 minutes
*******************************************************************************
Target pole/equ : undefined
Target radii    : 2.23 km                                                      
Center geodetic : 0.0, 0.0, -6378.137             {E-lon(deg),Lat(deg),Alt(km)}
Center cylindric: 0.0, 0.0, 0.0                   {E-lon(deg),Dxy(km),Dz(km)}
Center pole/equ : ITRF93                          {East-longitude positive}
Center radii    : 6378.137, 6378.137, 6356.752 km {Equator_a, b, pole_c}       
Target primary  : Sun
Vis. interferer : MOON (R_eq= 1737.400) km        {source: DE441}
Rel. light bend : Sun                             {source: DE441}
Rel. lght bnd GM: 1.3271E+11 km^3/s^2                                          
Small-body perts: Yes                             {source: SB441-N16}
Atmos refraction: NO (AIRLESS)
RA format       : DEG
Time format     : JD  
Calendar mode   : Mixed Julian/Gregorian
EOP file        : eop.230322.p230615                                           
EOP coverage    : DATA-BASED 1962-JAN-20 TO 2023-MAR-22. PREDICTS-> 2023-JUN-14
Units conversion: 1 au= 149597870.700 km, c= 299792.458 km/s, 1 day= 86400.0 s 
Table cut-offs 1: Elevation (-90.0deg=NO ),Airmass (>38.000=NO), Daylight (NO )
Table cut-offs 2: Solar elongation (  0.0,180.0=NO ),Local Hour Angle( 0.0=NO )
Table cut-offs 3: RA/DEC angular rate (     0.0=NO )                           
Table format    : Comma Separated Values (spreadsheet)
*******************************************************************************
Initial IAU76/J2000 heliocentric ecliptic osculating elements (au, days, deg.):
  EPOCH=  2456199.5 ! 2012-Sep-29.0000000 (TDB)    RMSW= n.a.                  
   EC= .1476581394100441   QR= 3.550719336771267   TP= 2455039.2047568592      
   OM= 77.08403534654171   W= 86.5924648418255     IN= 6.651025247302388       
  Equivalent ICRF heliocentric cartesian coordinates (au, au/d):
   X= 2.881257535953767E+00  Y=-3.142809987884802E+00  Z=-1.822004029378378E+00
  VX= 6.253668570706597E-03 VY= 4.037724524377757E-03 VZ= 1.093469058340452E-03
Comet physical (GM= km^3/s^2; RAD= km):                                        
   GM= n.a.                RAD= 2.23                                           
   M1=  6.7      M2=  12.1     k1=  14.    k2=  5.      PHCOF=  .030           
Comet non-gravitational force model (AMRAT=m^2/kg;A1-A3=au/d^2;DT=days;R0=au): 
   AMRAT=  0.                                      DT=  0.                     
   A1= 2.011297035217E-7   A2= -9.918458938599E-8  A3= 0.                      
 Standard model:                                                               
   ALN=  .1112620426   NK=  4.6142   NM=  2.15     NN=  5.093    R0=  2.808    
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
Date_________JDUT, , , R.A.___(ICRF), DEC____(ICRF),  R.A.__(a-app), DEC___(a-app),  dRA*cosD, d(DEC)/dt, Azimuth_(a-app), Elevation_(a-app),  L_Ap_Sid_Time,  a-mass, mag_ex,    T-mag,  N-mag,      Illu%,                r,       rdot,             delta,     deldot,     S-O-T,/r,     S-T-O,    PsAng,   PsAMV,      GlxLon,    GlxLat,  399_ins_LT,  L_Ap_Hour_Ang,  Sky_motion, Sky_mot_PA, RelVel-ANG, Lun_Sky_Brt  sky_SNR
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
$$SOE
2459123.500000000, , , 280.470762421, -27.037339151,  280.789180275, -27.017246588,  15.00575,  1.802519,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.042, 18.950,   98.74742,   4.498854145130,  1.9122072,  4.36269175363704, 28.5550472,   91.3458,/T,   12.8518,   85.753, 271.980,    7.588474,-10.034498,    0.000000,           n.a.,   0.2518938,  83.150343,  65.052235,        n.a.     n.a.
2459123.541666667, , , 280.475445855, -27.036847377,  280.793857460, -27.016746074,  15.02475,  1.804346,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.043, 18.950,   98.74744,   4.498900156252,  1.9121381,  4.36337892468115, 28.5554766,   91.3091,/T,   12.8517,   85.753, 271.978,    7.590743,-10.038051,    0.000000,           n.a.,   0.2522117,  83.152052,  65.021456,        n.a.     n.a.
2459123.583333333, , , 280.480135192, -27.036355106,  280.798540542, -27.016245045,  15.04374,  1.806174,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.043, 18.951,   98.74746,   4.498946165712,  1.9120690,  4.36406610593751, 28.5558960,   91.2725,/T,   12.8516,   85.754, 271.976,    7.593015,-10.041608,    0.000000,           n.a.,   0.2525296,  83.153752,  64.990689,        n.a.     n.a.
2459123.625000000, , , 280.484830429, -27.035862338,  280.803229518, -27.015743501,  15.06272,  1.808002,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.043, 18.951,   98.74748,   4.498992173509,  1.9119999,  4.36475329716432, 28.5563053,   91.2358,/T,   12.8515,   85.755, 271.974,    7.595289,-10.045170,    0.000000,           n.a.,   0.2528473,  83.155442,  64.959934,        n.a.     n.a.
2459123.666666667, , , 280.489531563, -27.035369075,  280.807924385, -27.015241440,  15.08169,  1.809830,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.044, 18.951,   98.74750,   4.499038179643,  1.9119308,  4.36544049811982, 28.5567045,   91.1992,/T,   12.8514,   85.756, 271.972,    7.597567,-10.048736,    0.000000,           n.a.,   0.2531648,  83.157122,  64.929190,        n.a.     n.a.
2459123.708333333, , , 280.494238593, -27.034875314,  280.812625142, -27.014738863,  15.10065,  1.811659,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.044, 18.952,   98.74752,   4.499084184115,  1.9118617,  4.36612770856241, 28.5570937,   91.1625,/T,   12.8513,   85.756, 271.969,    7.599846,-10.052307,    0.000000,           n.a.,   0.2534823,  83.158792,  64.898458,        n.a.     n.a.
2459123.750000000, , , 280.498951514, -27.034381056,  280.817331786, -27.014235769,  15.11960,  1.813489,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.045, 18.952,   98.74755,   4.499130186924,  1.9117926,  4.36681492825054, 28.5574729,   91.1259,/T,   12.8512,   85.757, 271.967,    7.602129,-10.055883,    0.000000,           n.a.,   0.2537996,  83.160453,  64.867738,        n.a.     n.a.
2459123.791666667, , , 280.503670325, -27.033886302,  280.822044314, -27.013732160,  15.13855,  1.815319,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.045, 18.952,   98.74757,   4.499176188070,  1.9117235,  4.36750215694277, 28.5578420,   91.0893,/T,   12.8511,   85.758, 271.965,    7.604414,-10.059464,    0.000000,           n.a.,   0.2541167,  83.162104,  64.837030,        n.a.     n.a.
2459123.833333333, , , 280.508395023, -27.033391050,  280.826762725, -27.013228033,  15.15749,  1.817149,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.045, 18.953,   98.74760,   4.499222187553,  1.9116544,  4.36818939439775, 28.5582012,   91.0526,/T,   12.8509,   85.758, 271.963,    7.606701,-10.063049,    0.000000,           n.a.,   0.2544337,  83.163746,  64.806333,        n.a.     n.a.
2459123.875000000, , , 280.513125605, -27.032895302,  280.831487016, -27.012723390,  15.17642,  1.818980,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.046, 18.953,   98.74763,   4.499268185373,  1.9115853,  4.36887664037423, 28.5585503,   91.0160,/T,   12.8508,   85.759, 271.961,    7.608992,-10.066638,    0.000000,           n.a.,   0.2547506,  83.165378,  64.775648,        n.a.     n.a.
2459123.916666667, , , 280.517862068, -27.032399055,  280.836217185, -27.012218230,  15.19534,  1.820811,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.046, 18.953,   98.74765,   4.499314181530,  1.9115162,  4.36956389463099, 28.5588893,   90.9794,/T,   12.8507,   85.760, 271.959,    7.611285,-10.070232,    0.000000,           n.a.,   0.2550673,  83.167001,  64.744975,        n.a.     n.a.
2459123.958333333, , , 280.522604411, -27.031902312,  280.840953230, -27.011712553,  15.21425,  1.822643,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.047, 18.954,   98.74768,   4.499360176024,  1.9114470,  4.37025115692697, 28.5592184,   90.9428,/T,   12.8505,   85.760, 271.957,    7.613580,-10.073831,    0.000000,           n.a.,   0.2553839,  83.168614,  64.714313,        n.a.     n.a.
2459124.000000000, , , 280.527352629, -27.031405070,  280.845695147, -27.011206359,  15.23315,  1.824475,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.047, 18.954,   98.74771,   4.499406168854,  1.9113779,  4.37093842702114, 28.5595374,   90.9062,/T,   12.8504,   85.761, 271.954,    7.615879,-10.077434,    0.000000,           n.a.,   0.2557004,  83.170218,  64.683663,        n.a.     n.a.
2459124.041666667, , , 280.532106720, -27.030907331,  280.850442936, -27.010699648,  15.25205,  1.826307,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.047, 18.955,   98.74775,   4.499452160021,  1.9113088,  4.37162570467259, 28.5598465,   90.8696,/T,   12.8502,   85.762, 271.952,    7.618180,-10.081042,    0.000000,           n.a.,   0.2560167,  83.171812,  64.653025,        n.a.     n.a.
2459124.083333333, , , 280.536866683, -27.030409094,  280.855196593, -27.010192418,  15.27094,  1.828141,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.048, 18.955,   98.74778,   4.499498149525,  1.9112397,  4.37231298964051, 28.5601455,   90.8330,/T,   12.8500,   85.762, 271.950,    7.620483,-10.084655,    0.000000,           n.a.,   0.2563329,  83.173397,  64.622398,        n.a.     n.a.
2459124.125000000, , , 280.541632513, -27.029910359,  280.859956116, -27.009684672,  15.28982,  1.829974,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.048, 18.955,   98.74781,   4.499544137365,  1.9111705,  4.37300028168408, 28.5604345,   90.7964,/T,   12.8499,   85.763, 271.948,    7.622790,-10.088272,    0.000000,           n.a.,   0.2566490,  83.174973,  64.591783,        n.a.     n.a.
2459124.166666667, , , 280.546404209, -27.029411126,  280.864721503, -27.009176407,  15.30869,  1.831808,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.049, 18.956,   98.74785,   4.499590123542,  1.9111014,  4.37368758056265, 28.5607135,   90.7598,/T,   12.8497,   85.764, 271.946,    7.625099,-10.091894,    0.000000,           n.a.,   0.2569649,  83.176540,  64.561179,        n.a.     n.a.
2459124.208333333, , , 280.551181768, -27.028911394,  280.869492752, -27.008667625,  15.32755,  1.833643,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.049, 18.956,   98.74788,   4.499636108054,  1.9110322,  4.37437488603562, 28.5609826,   90.7232,/T,   12.8495,   85.764, 271.944,    7.627410,-10.095520,    0.000000,           n.a.,   0.2572807,  83.178097,  64.530587,        n.a.     n.a.
2459124.250000000, , , 280.555965186, -27.028411164,  280.874269860, -27.008158324,  15.34640,  1.835478,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.049, 18.956,   98.74792,   4.499682090903,  1.9109631,  4.37506219786249, 28.5612416,   90.6866,/T,   12.8493,   85.765, 271.941,    7.629725,-10.099151,    0.000000,           n.a.,   0.2575963,  83.179645,  64.500007,        n.a.     n.a.
2459124.291666667, , , 280.560754462, -27.027910435,  280.879052825, -27.007648505,  15.36525,  1.837313,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.050, 18.957,   98.74796,   4.499728072088,  1.9108940,  4.37574951580278, 28.5614907,   90.6500,/T,   12.8491,   85.765, 271.939,    7.632041,-10.102787,    0.000000,           n.a.,   0.2579118,  83.181184,  64.469438,        n.a.     n.a.
2459124.333333333, , , 280.565549593, -27.027409208,  280.883841645, -27.007138168,  15.38409,  1.839149,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.050, 18.957,   98.74799,   4.499774051609,  1.9108248,  4.37643683961613, 28.5617297,   90.6134,/T,   12.8489,   85.766, 271.937,    7.634361,-10.106427,    0.000000,           n.a.,   0.2582272,  83.182714,  64.438880,        n.a.     n.a.
2459124.375000000, , , 280.570350576, -27.026907482,  280.888636317, -27.006627312,  15.40292,  1.840985,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.051, 18.957,   98.74803,   4.499820029466,  1.9107556,  4.37712416906225, 28.5619588,   90.5769,/T,   12.8487,   85.767, 271.935,    7.636683,-10.110072,    0.000000,           n.a.,   0.2585424,  83.184234,  64.408334,        n.a.     n.a.
2459124.416666667, , , 280.575157408, -27.026405256,  280.893436839, -27.006115938,  15.42174,  1.842822,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.051, 18.958,   98.74807,   4.499866005659,  1.9106865,  4.37781150390094, 28.5621779,   90.5403,/T,   12.8485,   85.767, 271.933,    7.639008,-10.113721,    0.000000,           n.a.,   0.2588575,  83.185746,  64.377799,        n.a.     n.a.
2459124.458333333, , , 280.579970087, -27.025902532,  280.898243209, -27.005604045,  15.44055,  1.844659,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.051, 18.958,   98.74812,   4.499911980187,  1.9106173,  4.37849884389201, 28.5623870,   90.5037,/T,   12.8483,   85.768, 271.931,    7.641336,-10.117375,    0.000000,           n.a.,   0.2591725,  83.187248,  64.347276,        n.a.     n.a.
2459124.500000000, , , 280.584788610, -27.025399308,  280.903055425, -27.005091633,  15.45935,  1.846497,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.052, 18.958,   98.74816,   4.499957953051,  1.9105481,  4.37918618879540, 28.5625862,   90.4672,/T,   12.8481,   85.769, 271.928,    7.643666,-10.121033,    0.000000,           n.a.,   0.2594873,  83.188742,  64.316764,        n.a.     n.a.
$$EOE
)";

            const string table_obs = R"(
*******************************************************************************
Ephemeris / WWW_USER Fri Mar 24 06:06:35 2023 Pasadena, USA      / Horizons    
*******************************************************************************
Target body name: 74P/Smirnova-Chernykh           {source: JPL#K183/41}
Center body name: Earth (399)                     {source: DE441}
Center-site name: Mauna Kea
*******************************************************************************
Start time      : A.D. 2020-Oct-01 00:00:00.0000 UT      
Stop  time      : A.D. 2020-Oct-02 00:00:00.0000 UT      
Step-size       : 60 minutes
*******************************************************************************
Target pole/equ : undefined
Target radii    : 2.23 km                                                      
Center geodetic : 204.5278, 19.8260847, 4.21024   {E-lon(deg),Lat(deg),Alt(km)}
Center cylindric: 204.5278, 6006.35451, 2151.0229 {E-lon(deg),Dxy(km),Dz(km)}
Center pole/equ : ITRF93                          {East-longitude positive}
Center radii    : 6378.137, 6378.137, 6356.752 km {Equator_a, b, pole_c}       
Target primary  : Sun
Vis. interferer : MOON (R_eq= 1737.400) km        {source: DE441}
Rel. light bend : Sun                             {source: DE441}
Rel. lght bnd GM: 1.3271E+11 km^3/s^2                                          
Small-body perts: Yes                             {source: SB441-N16}
Atmos refraction: NO (AIRLESS)
RA format       : DEG
Time format     : JD  
Calendar mode   : Mixed Julian/Gregorian
EOP file        : eop.230322.p230615                                           
EOP coverage    : DATA-BASED 1962-JAN-20 TO 2023-MAR-22. PREDICTS-> 2023-JUN-14
Units conversion: 1 au= 149597870.700 km, c= 299792.458 km/s, 1 day= 86400.0 s 
Table cut-offs 1: Elevation (-90.0deg=NO ),Airmass (>38.000=NO), Daylight (NO )
Table cut-offs 2: Solar elongation (  0.0,180.0=NO ),Local Hour Angle( 0.0=NO )
Table cut-offs 3: RA/DEC angular rate (     0.0=NO )                           
Table format    : Comma Separated Values (spreadsheet)
*******************************************************************************
Initial IAU76/J2000 heliocentric ecliptic osculating elements (au, days, deg.):
  EPOCH=  2456199.5 ! 2012-Sep-29.0000000 (TDB)    RMSW= n.a.                  
   EC= .1476581394100441   QR= 3.550719336771267   TP= 2455039.2047568592      
   OM= 77.08403534654171   W= 86.5924648418255     IN= 6.651025247302388       
  Equivalent ICRF heliocentric cartesian coordinates (au, au/d):
   X= 2.881257535953767E+00  Y=-3.142809987884802E+00  Z=-1.822004029378378E+00
  VX= 6.253668570706597E-03 VY= 4.037724524377757E-03 VZ= 1.093469058340452E-03
Comet physical (GM= km^3/s^2; RAD= km):                                        
   GM= n.a.                RAD= 2.23                                           
   M1=  6.7      M2=  12.1     k1=  14.    k2=  5.      PHCOF=  .030           
Comet non-gravitational force model (AMRAT=m^2/kg;A1-A3=au/d^2;DT=days;R0=au): 
   AMRAT=  0.                                      DT=  0.                     
   A1= 2.011297035217E-7   A2= -9.918458938599E-8  A3= 0.                      
 Standard model:                                                               
   ALN=  .1112620426   NK=  4.6142   NM=  2.15     NN=  5.093    R0=  2.808    
**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
Date_________JDUT, , , R.A.___(ICRF), DEC____(ICRF),  R.A.__(a-app), DEC___(a-app),  dRA*cosD, d(DEC)/dt, Azimuth_(a-app), Elevation_(a-app),  L_Ap_Sid_Time,  a-mass, mag_ex,    T-mag,  N-mag,      Illu%,                r,       rdot,             delta,     deldot,     S-O-T,/r,     S-T-O,    PsAng,   PsAMV,      GlxLon,    GlxLat,  399_ins_LT,  L_Ap_Hour_Ang,  Sky_motion, Sky_mot_PA, RelVel-ANG,  Lun_Sky_Brt, sky_SNR,
**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
$$SOE
2459123.500000000,*, , 280.471302913, -27.037605563,  280.789759480, -27.017477211,  14.80341,  1.595797,   124.027894607,      10.705314653,  14.3141162690,   5.204,  0.567,   19.042, 18.950,   98.74751,   4.498854145181,  1.9122072,  4.36268378112256, 28.1984765,   91.3467,/T,   12.8513,   85.751, 271.980,    7.588487,-10.035063,    0.000355,   -4.405201030,   0.2481529,  83.847315,  65.104753,         n.a.,    n.a.,
2459123.541666667,*, , 280.475905342, -27.037167057,  280.794376777, -27.017035320,  14.71126,  1.628583,   131.704559575,      21.892822543,  15.3168540765,   2.662,  0.290,   19.043, 18.950,   98.74751,   4.498900156354,  1.9121381,  4.36336296615753, 28.2521468,   91.3105,/T,   12.8513,   85.752, 271.978,    7.590679,-10.038592,    0.000355,   -3.402771042,   0.2466855,  83.682898,  65.272296,         n.a.,    n.a.,
2459123.583333333,*, , 280.480482211, -27.036717664,  280.798964438, -27.016584609,  14.64059,  1.673398,   142.059691769,      31.594438356,  16.3195918837,   1.902,  0.207,   19.043, 18.951,   98.74751,   4.498946165855,  1.9120690,  4.36404370140604, 28.3265788,   91.2741,/T,   12.8513,   85.752, 271.976,    7.592867,-10.042094,    0.000355,   -2.400339079,   0.2455986,  83.479473,  65.421970,         n.a.,    n.a.,
2459123.625000000,*, , 280.485041228, -27.036254452,  280.803529006, -27.016121634,  14.59755,  1.727297,   155.802619881,      38.940280784,  17.3223296908,   1.588,  0.173,   19.043, 18.951,   98.74751,   4.498992173680,  1.9119999,  4.36472642804576, 28.4167044,   91.2376,/T,   12.8513,   85.753, 271.974,    7.595058,-10.045573,    0.000355,   -1.397905576,   0.2449898,  83.251690,  65.541001,         n.a.,    n.a.,
2459123.666666667,*,m, 280.489591725, -27.035775399,  280.808079003, -27.015643757,  14.58636,  1.786710,   172.790445894,      42.806788050,  18.3250674977,   1.469,  0.160,   19.044, 18.951,   98.74751,   4.499038179829,  1.9119308,  4.36541145157329, 28.5163801,   91.2010,/T,   12.8513,   85.754, 271.972,    7.597257,-10.049033,    0.000355,   -0.395471102,   0.2449230,  83.016524,  65.619012,         n.a.,    n.a.,
2459123.708333333,A,m, 280.494144019, -27.035279536,  280.812624350, -27.015149325,  14.60909,  1.847693,   190.993636758,      42.334965749,  19.3278053044,   1.482,  0.162,   19.044, 18.952,   98.74750,   4.499084184299,  1.9118617,  4.36609892086551, 28.6188075,   91.1642,/T,   12.8513,   85.755, 271.969,    7.599469,-10.052482,    0.000355,    0.606963681,   0.2454245,  82.791756,  65.648785,        2.261,   8.381,
2459123.750000000, ,m, 280.498708701, -27.034767010,  280.817175687, -27.014637785,  14.66546,  1.906194,   207.396384750,      37.642422228,  20.3305431110,   1.634,  0.178,   19.045, 18.952,   98.74750,   4.499130187090,  1.9117926,  4.36678881796635, 28.7169993,   91.1272,/T,   12.8514,   85.755, 271.967,    7.601699,-10.055929,    0.000355,    1.609398065,   0.2464804,  82.594300,  65.626691,        2.465,   7.687,
2459123.791666667, ,m, 280.503295917, -27.034239077,  280.821743644, -27.014109718,  14.75291,  1.958336,   220.390043938,      29.711131292,  21.3332809175,   2.010,  0.219,   19.045, 18.952,   98.74750,   4.499176188205,  1.9117235,  4.36748095929894, 28.8042573,   91.0902,/T,   12.8514,   85.756, 271.965,    7.603951,-10.059383,    0.000355,    2.611831341,   0.2480386,  82.438628,  65.552809,        2.579,   7.349,
2459123.833333333, ,m, 280.507914669, -27.033698010,  280.826338111, -27.013566803,  14.86672,  2.000674,   230.114052647,      19.635382899,  22.3360187238,   2.947,  0.321,   19.045, 18.953,   98.74751,   4.499222187645,  1.9116544,  4.36817500822000, 28.8746315,   91.0531,/T,   12.8513,   85.757, 271.963,    7.606226,-10.062851,    0.000355,    3.614262850,   0.2500123,  82.335528,  65.430735,        2.681,   7.069,
2459123.875000000, ,m, 280.512572199, -27.033146950,  280.830967564, -27.013011697,  15.00041,  2.030439,   237.325735986,       8.214416254,  23.3387565302,   6.615,  0.721,   19.046, 18.953,   98.74753,   4.499268185412,  1.9115853,  4.36887049805668, 28.9233272,   91.0159,/T,   12.8513,   85.758, 271.961,    7.608526,-10.066343,    0.000355,    4.616692026,   0.2522867,  82.291359,  65.267177,        2.834,   6.687,
2459123.916666667, ,m, 280.517273496, -27.032589685,  280.835638484, -27.012447858,  15.14610,  2.045723,   242.710427005,      -4.049109797,   0.3414943365,    n.a.,   n.a.,   19.046, 18.953,   98.74755,   4.499314181511,  1.9115162,  4.36956686404764, 28.9470339,   90.9787,/T,   12.8512,   85.759, 271.959,    7.610850,-10.069864,    0.000355,    5.619118438,   0.2547271,  82.307840,  65.071374,         n.a.,    n.a.,
2459123.958333333, ,m, 280.522020951, -27.032030393,  280.840354912, -27.011879302,  15.29511,  2.045610,   246.717388224,     -16.846921728,   1.3442321427,    n.a.,   n.a.,   19.047, 18.954,   98.74758,   4.499360175945,  1.9114470,  4.37026348200108, 28.9441512,   90.9416,/T,   12.8511,   85.760, 271.957,    7.613196,-10.073420,    0.000355,    6.621541815,   0.2571882,  82.382309,  64.854437,         n.a.,    n.a.,
2459124.000000000, ,m, 280.526814199, -27.031473355,  280.845118175, -27.011310335,  15.43853,  2.030239,   249.551571773,     -29.981739014,   2.3469699489,    n.a.,   n.a.,   19.047, 18.954,   98.74762,   4.499406168719,  1.9113779,  4.37095971102154, 28.9148992,   90.9045,/T,   12.8509,   85.761, 271.955,    7.615560,-10.077014,    0.000355,    7.623962071,   0.2595242,  82.508324,  64.628638,         n.a.,    n.a.,
2459124.041666667, ,m, 280.531650141, -27.030922662,  280.849926798, -27.010745250,  15.56784,  2.000794,   251.119599718,     -43.311332125,   3.3497077551,    n.a.,   n.a.,   19.047, 18.955,   98.74767,   4.499452159835,  1.9113088,  4.37165493737986, 28.8613028,   90.8675,/T,   12.8507,   85.762, 271.952,    7.617938,-10.080646,    0.000355,    8.626379302,   0.2615981,  82.676436,  64.406692,         n.a.,    n.a.,
2459124.083333333, ,m, 280.536523158, -27.030381935,  280.854776600, -27.010188040,  15.67548,  1.959421,   250.704334667,     -56.696884915,   4.3524455613,    n.a.,   n.a.,   19.048, 18.955,   98.74772,   4.499498149298,  1.9112397,  4.37234861652211, 28.7870530,   90.8306,/T,   12.8504,   85.763, 271.950,    7.620325,-10.084315,    0.000355,    9.628793788,   0.2632912,  82.875035,  64.201047,         n.a.,    n.a.,
2459124.125000000,A,m, 280.541425497, -27.029854077,  280.859660988, -27.009642121,  15.75539,  1.909083,   245.221196317,     -69.869408918,   5.3551833676,    n.a.,   n.a.,   19.048, 18.955,   98.74778,   4.499544137110,  1.9111705,  4.37304031034103, 28.6972547,   90.7938,/T,   12.8501,   85.763, 271.948,    7.622715,-10.088016,    0.000355,   10.631205968,   0.2645106,  83.091145,  64.023183,         n.a.,    n.a.,
2459124.166666667,C,m, 280.546347802, -27.029341076,  280.864571401, -27.009110101,  15.80340,  1.853354,   214.015438899,     -81.226553788,   6.3579211740,    n.a.,   n.a.,   19.049, 18.956,   98.74784,   4.499590123273,  1.9111014,  4.37372971715852, 28.5980766,   90.7572,/T,   12.8498,   85.764, 271.946,    7.625101,-10.091745,    0.000355,   11.633616414,   0.2651951,  83.311154,  63.882947,         n.a.,    n.a.,
2459124.208333333,*, , 280.551279754, -27.028843866,  280.869497905, -27.008593598,  15.81752,  1.796177,   131.186247732,     -78.684251736,   7.3606589804,    n.a.,   n.a.,   19.049, 18.956,   98.74790,   4.499636107788,  1.9110322,  4.37441669236627, 28.4963289,   90.7208,/T,   12.8495,   85.764, 271.944,    7.627480,-10.095493,    0.000355,  -11.363974213,   0.2653195,  83.521462,  63.787926,         n.a.,    n.a.,
2459124.250000000,*, , 280.556210780, -27.028362268,  280.874429866, -27.008093134,  15.79808,  1.741592,   112.355999941,     -66.380252801,   8.3633967869,    n.a.,   n.a.,   19.049, 18.956,   98.74796,   4.499682090654,  1.9109631,  4.37510125831169, 28.3989972,   90.6845,/T,   12.8492,   85.765, 271.941,    7.629846,-10.099252,    0.000355,  -10.361565204,   0.2648964,  83.709073,  63.742901,         n.a.,    n.a.,
2459124.291666667,*, , 280.561130772, -27.027894998,  280.879356682, -27.007608096,  15.74772,  1.693461,   108.891942635,     -53.101054790,   9.3661345935,    n.a.,   n.a.,   19.050, 18.957,   98.74802,   4.499728071871,  1.9108940,  4.37578360275233, 28.3127642,   90.6483,/T,   12.8489,   85.765, 271.939,    7.632196,-10.103014,    0.000355,   -9.359155852,   0.2639752,  83.862176,  63.749419,         n.a.,    n.a.,
2459124.333333333,*, , 280.566030784, -27.027439759,  280.884268508, -27.007136780,  15.67119,  1.655203,   109.150201991,     -39.713751136,  10.3688724003,    n.a.,   n.a.,   19.050, 18.957,   98.74808,   4.499774051435,  1.9108248,  4.37646406598469, 28.2435519,   90.6122,/T,   12.8486,   85.766, 271.937,    7.634527,-10.106770,    0.000355,   -8.356745500,   0.2626393,  83.970730,  63.805532,         n.a.,    n.a.,
2459124.375000000,*, , 280.570903642, -27.026993397,  280.889156927, -27.006676509,  15.57502,  1.629558,   111.091695907,     -26.423416150,  11.3716102072,    n.a.,   n.a.,   19.051, 18.957,   98.74813,   4.499820029345,  1.9107556,  4.37714311752812, 28.1961161,   90.5762,/T,   12.8483,   85.766, 271.935,    7.636839,-10.110512,    0.000355,   -7.354333588,   0.2610005,  84.027079,  63.905774,         n.a.,    n.a.,
2459124.416666667,*, , 280.575744432, -27.026552115,  280.894015530, -27.006223815,  15.46709,  1.618405,   114.235273212,     -13.363157316,  12.3743480144,    n.a.,   n.a.,   19.051, 18.958,   98.74817,   4.499866005596,  1.9106865,  4.37782132396019, 28.1737212,   90.5402,/T,   12.8480,   85.766, 271.933,    7.639133,-10.114233,    0.000355,   -6.351919688,   0.2591922,  84.026570,  64.041394,         n.a.,    n.a.,
2459124.458333333,*, , 280.580550839, -27.026111737,  280.898840349, -27.005774677,  15.35609,  1.622628,   118.581801169,      -0.685330795,  13.3770858216,    n.a.,   n.a.,   19.051, 18.958,   98.74821,   4.499911980184,  1.9106173,  4.37849931010514, 28.1779159,   90.5042,/T,   12.8478,   85.767, 271.930,    7.641410,-10.117929,    0.000355,   -5.349503535,   0.2573597,  83.968125,  64.200907,         n.a.,    n.a.,
2459124.500000000,*, , 280.585323302, -27.025667993,  280.903630132, -27.005324794,  15.25090,  1.642058,   124.402783921,      11.389380564,  14.3798236291,   4.914,  0.535,   19.052, 18.958,   98.74825,   4.499957953105,  1.9105481,  4.37917771623301, 28.2084276,   90.4681,/T,   12.8476,   85.767, 271.928,    7.643674,-10.121596,    0.000355,   -4.347085046,   0.2556507,  83.854662,  64.370901,         n.a.,    n.a.,
$$EOE
    )";

            const Ephemeris eph_geo = horizons_to_ephemeris(table_geo);
            const Ephemeris eph_obs = horizons_to_ephemeris(table_obs);
            const Observatory obs{204.5278, 0.94171, +0.33725}; // Mauna Kea (568)
            for (int i = 0; i < eph_obs.num_vertices(); i++)
            {
                S2LatLng coords_geo = eph_geo.data(i).as_s2latlng();
                S2LatLng coords_obs = eph_obs.data(i).as_s2latlng();
                S2LatLng coords = obs.parallax(coords_geo, eph_geo.data(i).mjd, eph_geo.data(i).delta);
                EXPECT_NEAR(coords.lng().radians(), coords_obs.lng().radians(), 0.01 * ARCSEC);
                EXPECT_NEAR(coords.lat().radians(), coords_obs.lat().radians(), 0.01 * ARCSEC);
            }
        }
    }
}