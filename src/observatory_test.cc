#include "config.h"

#include <vector>
#include <gtest/gtest.h>
#include <s2/s2latlng.h>

#include "ephemeris.h"
#include "moving_target.h"
#include "observatory.h"
#include "util.h"

using std::string;

namespace sbsearch
{
  namespace testing
  {
    const Ephemeris horizons_to_ephemeris(const string &horizons_table)
    {
      Ephemeris::Data data;
      bool table_content = false;
      for (const string &line : split(horizons_table, '\n'))
      {
        if (line == "$$EOE")
          break;

        if (table_content)
        {
          const vector<string> columns = split(line, ',');
          data.push_back({.mjd = std::stod(columns[0]) - 2400000.5,
                          .ra = std::stod(columns[3]),
                          .dec = std::stod(columns[4]),
                          .delta = std::stod(columns[19])});
        }

        if (line == "$$SOE")
          table_content = true;
      }
      Ephemeris eph{MovingTarget(), data};
      return eph;
    }

    TEST(ObservatoryTests, ObservatoryMars)
    {
      // Meeus example 40a
      Observatory palomar{-(7 + 47. / 60 + 27. / 3600) * 15, 0.836339, 0.546861};
      S2LatLng mars = S2LatLng::FromDegrees(-15.7710833333, 339.53020833333); // apparent Dec, RA
      S2LatLng coords = palomar.parallax(mars, 52879.13680555556, 0.37276);
      EXPECT_NEAR(coords.lng().degrees(), (22 + 38. / 60 + 8.54 / 3600) * 15, 4 * ARCSEC);
      EXPECT_NEAR(coords.lat().degrees(), -(15 + 46. / 60 + 30.0 / 3600), 3 * ARCSEC);
    }

    TEST(ObservatoryTests, ObservatoryHartley2)
    {
      // Astrometric ephemeris for Hartley 2, 24 hour period starting 2010 Oct 1 at LDT
      vector<vector<double>> ephemeris_obs = {{2455470.500000000, 10.472347936, 55.031215755, 0.18417361441047},
                                              {2455470.541666667, 10.577003772, 55.054297704, 0.18394075762819},
                                              {2455470.583333333, 10.680740819, 55.077392096, 0.18370797528808},
                                              {2455470.625000000, 10.783552925, 55.100340543, 0.18347562045185},
                                              {2455470.666666667, 10.885520820, 55.122989008, 0.18324403355769},
                                              {2455470.708333333, 10.986807086, 55.145198203, 0.18301351948325},
                                              {2455470.750000000, 11.087645526, 55.166853042, 0.18278432703335},
                                              {2455470.791666667, 11.188325638, 55.187870469, 0.18255663223752},
                                              {2455470.833333333, 11.289173221, 55.208205154, 0.18233052658407},
                                              {2455470.875000000, 11.390528427, 55.227852624, 0.18210601098197},
                                              {2455470.916666667, 11.492722753, 55.246849631, 0.18188299585280},
                                              {2455470.958333333, 11.596056556, 55.265271709, 0.18166130733872},
                                              {2455471.000000000, 11.700778626, 55.283228091, 0.18144069919759},
                                              {2455471.041666667, 11.807069231, 55.300854315, 0.18122086957160},
                                              {2455471.083333333, 11.915027790, 55.318303051, 0.18100148148755},
                                              {2455471.125000000, 12.024666001, 55.335733740, 0.18078218569677},
                                              {2455471.166666667, 12.135906913, 55.353301768, 0.18056264430844},
                                              {2455471.208333333, 12.248589968, 55.371147908, 0.18034255362005},
                                              {2455471.250000000, 12.362481698, 55.389388722, 0.18012166460761},
                                              {2455471.291666667, 12.477291336, 55.408108595, 0.17989979969904},
                                              {2455471.333333333, 12.592690318, 55.427353905, 0.17967686470794},
                                              {2455471.375000000, 12.708334360, 55.447129742, 0.17945285513194},
                                              {2455471.416666667, 12.823886660, 55.467399399, 0.17922785640023},
                                              {2455471.458333333, 12.939040676, 55.488086657, 0.17900203806123},
                                              {2455471.500000000, 13.053540963, 55.509080744, 0.17877564230828}};

      vector<vector<double>> ephemeris_geo = {{2455470.500000000, 10.454737412, 55.038928622, 0.18418578033653},
                                              {2455470.541666667, 10.558082802, 55.059766962, 0.18395797236107},
                                              {2455470.583333333, 10.661785490, 55.080532093, 0.18373040987549},
                                              {2455470.625000000, 10.765846373, 55.101223249, 0.18350309353657},
                                              {2455470.666666667, 10.870266340, 55.121839655, 0.18327602400408},
                                              {2455470.708333333, 10.975046280, 55.142380533, 0.18304920194081},
                                              {2455470.750000000, 11.080187072, 55.162845098, 0.18282262801256},
                                              {2455470.791666667, 11.185689592, 55.183232562, 0.18259630288816},
                                              {2455470.833333333, 11.291554710, 55.203542127, 0.18237022723948},
                                              {2455470.875000000, 11.397783290, 55.223772995, 0.18214440174140},
                                              {2455470.916666667, 11.504376191, 55.243924359, 0.18191882707189},
                                              {2455470.958333333, 11.611334266, 55.263995406, 0.18169350391193},
                                              {2455471.000000000, 11.718658360, 55.283985321, 0.18146843294560},
                                              {2455471.041666667, 11.826349314, 55.303893279, 0.18124361486000},
                                              {2455471.083333333, 11.934407962, 55.323718454, 0.18101905034535},
                                              {2455471.125000000, 12.042835130, 55.343460010, 0.18079474009491},
                                              {2455471.166666667, 12.151631641, 55.363117108, 0.18057068480507},
                                              {2455471.208333333, 12.260798306, 55.382688903, 0.18034688517527},
                                              {2455471.250000000, 12.370335934, 55.402174545, 0.18012334190809},
                                              {2455471.291666667, 12.480245323, 55.421573176, 0.17990005570917},
                                              {2455471.333333333, 12.590527266, 55.440883935, 0.17967702728732},
                                              {2455471.375000000, 12.701182548, 55.460105955, 0.17945425735441},
                                              {2455471.416666667, 12.812211946, 55.479238360, 0.17923174662549},
                                              {2455471.458333333, 12.923616230, 55.498280274, 0.17900949581870},
                                              {2455471.500000000, 13.035396161, 55.517230810, 0.17878750565534}};

      Observatory obs{248.57749, 0.822887, 0.566916}; // Lowell Discovery Telescope (G37)
      for (int i = 0; i < ephemeris_obs.size(); i++)
      {
        S2LatLng coords_geo = S2LatLng::FromDegrees(ephemeris_geo[i][2], ephemeris_geo[i][1]);
        S2LatLng coords_obs = S2LatLng::FromDegrees(ephemeris_obs[i][2], ephemeris_obs[i][1]);
        S2LatLng coords = obs.parallax(coords_geo, ephemeris_geo[i][0] - 2400000.5, ephemeris_geo[i][3]);
        EXPECT_NEAR(coords.lng().radians(), coords_obs.lng().radians(), 0.1 * ARCSEC);
        EXPECT_NEAR(coords.lat().radians(), coords_obs.lat().radians(), 0.1 * ARCSEC);
      }
    }

    TEST(ObservatoryTests, Observatory74PParallax)
    {
      const string table_geo = R"(
*******************************************************************************
JPL/HORIZONS                74P/Smirnova-Chernykh          2023-Mar-24 06:04:43
Rec #:90000817 (+COV) Soln.date: 2023-Jan-23_00:02:38   # obs: 5844 (1997-2023)
 
IAU76/J2000 helio. ecliptic osc. elements (au, days, deg., period=Julian yrs):
 
  EPOCH=  2456199.5 ! 2012-Sep-29.0000000 (TDB)    RMSW= n.a.
   EC= .1476581394100441   QR= 3.550719336771267   TP= 2455039.2047568592
   OM= 77.08403534654171   W= 86.5924648418255     IN= 6.651025247302388
   A= 4.165839437140405    MA= 134.4989194000786   ADIST= 4.780959537509543
   PER= 8.5028005667983    N= .115917841           ANGMOM= .03472529
   DAN= 4.03956            DDN= 4.11109            L= 163.6534671
   B= 6.6392134            MOID= 2.56964993        TP= 2009-Jul-26.7047568592
 
Comet physical (GM= km^3/s^2; RAD= km):
   GM= n.a.                RAD= 2.23
   M1=  6.7      M2=  12.1     k1=  14.    k2=  5.      PHCOF=  .030
 
Comet non-gravitational force model (AMRAT=m^2/kg;A1-A3=au/d^2;DT=days;R0=au):
   AMRAT=  0.                                      DT=  0.
   A1= 2.011297035217E-7   A2= -9.918458938599E-8  A3= 0.
 Standard model:
   ALN=  .1112620426   NK=  4.6142   NM=  2.15     NN=  5.093    R0=  2.808
 
COMET comments 
1: soln ref.= JPL#K183/41, data arc: 1997-07-14 to 2023-01-09
2: k1=14., k2=5., phase coef.=0.03;
*******************************************************************************


*******************************************************************************
Ephemeris / WWW_USER Fri Mar 24 06:04:43 2023 Pasadena, USA      / Horizons    
*******************************************************************************
Target body name: 74P/Smirnova-Chernykh           {source: JPL#K183/41}
Center body name: Earth (399)                     {source: DE441}
Center-site name: GEOCENTRIC
*******************************************************************************
Start time      : A.D. 2020-Oct-01 00:00:00.0000 UT      
Stop  time      : A.D. 2020-Oct-02 00:00:00.0000 UT      
Step-size       : 60 minutes
*******************************************************************************
Target pole/equ : undefined
Target radii    : 2.23 km                                                      
Center geodetic : 0.0, 0.0, -6378.137             {E-lon(deg),Lat(deg),Alt(km)}
Center cylindric: 0.0, 0.0, 0.0                   {E-lon(deg),Dxy(km),Dz(km)}
Center pole/equ : ITRF93                          {East-longitude positive}
Center radii    : 6378.137, 6378.137, 6356.752 km {Equator_a, b, pole_c}       
Target primary  : Sun
Vis. interferer : MOON (R_eq= 1737.400) km        {source: DE441}
Rel. light bend : Sun                             {source: DE441}
Rel. lght bnd GM: 1.3271E+11 km^3/s^2                                          
Small-body perts: Yes                             {source: SB441-N16}
Atmos refraction: NO (AIRLESS)
RA format       : DEG
Time format     : JD  
Calendar mode   : Mixed Julian/Gregorian
EOP file        : eop.230322.p230615                                           
EOP coverage    : DATA-BASED 1962-JAN-20 TO 2023-MAR-22. PREDICTS-> 2023-JUN-14
Units conversion: 1 au= 149597870.700 km, c= 299792.458 km/s, 1 day= 86400.0 s 
Table cut-offs 1: Elevation (-90.0deg=NO ),Airmass (>38.000=NO), Daylight (NO )
Table cut-offs 2: Solar elongation (  0.0,180.0=NO ),Local Hour Angle( 0.0=NO )
Table cut-offs 3: RA/DEC angular rate (     0.0=NO )                           
Table format    : Comma Separated Values (spreadsheet)
*******************************************************************************
Initial IAU76/J2000 heliocentric ecliptic osculating elements (au, days, deg.):
  EPOCH=  2456199.5 ! 2012-Sep-29.0000000 (TDB)    RMSW= n.a.                  
   EC= .1476581394100441   QR= 3.550719336771267   TP= 2455039.2047568592      
   OM= 77.08403534654171   W= 86.5924648418255     IN= 6.651025247302388       
  Equivalent ICRF heliocentric cartesian coordinates (au, au/d):
   X= 2.881257535953767E+00  Y=-3.142809987884802E+00  Z=-1.822004029378378E+00
  VX= 6.253668570706597E-03 VY= 4.037724524377757E-03 VZ= 1.093469058340452E-03
Comet physical (GM= km^3/s^2; RAD= km):                                        
   GM= n.a.                RAD= 2.23                                           
   M1=  6.7      M2=  12.1     k1=  14.    k2=  5.      PHCOF=  .030           
Comet non-gravitational force model (AMRAT=m^2/kg;A1-A3=au/d^2;DT=days;R0=au): 
   AMRAT=  0.                                      DT=  0.                     
   A1= 2.011297035217E-7   A2= -9.918458938599E-8  A3= 0.                      
 Standard model:                                                               
   ALN=  .1112620426   NK=  4.6142   NM=  2.15     NN=  5.093    R0=  2.808    
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
Date_________JDUT, , , R.A.___(ICRF), DEC____(ICRF),  R.A.__(a-app), DEC___(a-app),  dRA*cosD, d(DEC)/dt, Azimuth_(a-app), Elevation_(a-app),  L_Ap_Sid_Time,  a-mass, mag_ex,    T-mag,  N-mag,      Illu%,                r,       rdot,             delta,     deldot,     S-O-T,/r,     S-T-O,    PsAng,   PsAMV,      GlxLon,    GlxLat,  399_ins_LT,  L_Ap_Hour_Ang,  Sky_motion, Sky_mot_PA, RelVel-ANG, Lun_Sky_Brt  sky_SNR
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
$$SOE
2459123.500000000, , , 280.470762421, -27.037339151,  280.789180275, -27.017246588,  15.00575,  1.802519,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.042, 18.950,   98.74742,   4.498854145130,  1.9122072,  4.36269175363704, 28.5550472,   91.3458,/T,   12.8518,   85.753, 271.980,    7.588474,-10.034498,    0.000000,           n.a.,   0.2518938,  83.150343,  65.052235,        n.a.     n.a.
2459123.541666667, , , 280.475445855, -27.036847377,  280.793857460, -27.016746074,  15.02475,  1.804346,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.043, 18.950,   98.74744,   4.498900156252,  1.9121381,  4.36337892468115, 28.5554766,   91.3091,/T,   12.8517,   85.753, 271.978,    7.590743,-10.038051,    0.000000,           n.a.,   0.2522117,  83.152052,  65.021456,        n.a.     n.a.
2459123.583333333, , , 280.480135192, -27.036355106,  280.798540542, -27.016245045,  15.04374,  1.806174,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.043, 18.951,   98.74746,   4.498946165712,  1.9120690,  4.36406610593751, 28.5558960,   91.2725,/T,   12.8516,   85.754, 271.976,    7.593015,-10.041608,    0.000000,           n.a.,   0.2525296,  83.153752,  64.990689,        n.a.     n.a.
2459123.625000000, , , 280.484830429, -27.035862338,  280.803229518, -27.015743501,  15.06272,  1.808002,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.043, 18.951,   98.74748,   4.498992173509,  1.9119999,  4.36475329716432, 28.5563053,   91.2358,/T,   12.8515,   85.755, 271.974,    7.595289,-10.045170,    0.000000,           n.a.,   0.2528473,  83.155442,  64.959934,        n.a.     n.a.
2459123.666666667, , , 280.489531563, -27.035369075,  280.807924385, -27.015241440,  15.08169,  1.809830,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.044, 18.951,   98.74750,   4.499038179643,  1.9119308,  4.36544049811982, 28.5567045,   91.1992,/T,   12.8514,   85.756, 271.972,    7.597567,-10.048736,    0.000000,           n.a.,   0.2531648,  83.157122,  64.929190,        n.a.     n.a.
2459123.708333333, , , 280.494238593, -27.034875314,  280.812625142, -27.014738863,  15.10065,  1.811659,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.044, 18.952,   98.74752,   4.499084184115,  1.9118617,  4.36612770856241, 28.5570937,   91.1625,/T,   12.8513,   85.756, 271.969,    7.599846,-10.052307,    0.000000,           n.a.,   0.2534823,  83.158792,  64.898458,        n.a.     n.a.
2459123.750000000, , , 280.498951514, -27.034381056,  280.817331786, -27.014235769,  15.11960,  1.813489,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.045, 18.952,   98.74755,   4.499130186924,  1.9117926,  4.36681492825054, 28.5574729,   91.1259,/T,   12.8512,   85.757, 271.967,    7.602129,-10.055883,    0.000000,           n.a.,   0.2537996,  83.160453,  64.867738,        n.a.     n.a.
2459123.791666667, , , 280.503670325, -27.033886302,  280.822044314, -27.013732160,  15.13855,  1.815319,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.045, 18.952,   98.74757,   4.499176188070,  1.9117235,  4.36750215694277, 28.5578420,   91.0893,/T,   12.8511,   85.758, 271.965,    7.604414,-10.059464,    0.000000,           n.a.,   0.2541167,  83.162104,  64.837030,        n.a.     n.a.
2459123.833333333, , , 280.508395023, -27.033391050,  280.826762725, -27.013228033,  15.15749,  1.817149,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.045, 18.953,   98.74760,   4.499222187553,  1.9116544,  4.36818939439775, 28.5582012,   91.0526,/T,   12.8509,   85.758, 271.963,    7.606701,-10.063049,    0.000000,           n.a.,   0.2544337,  83.163746,  64.806333,        n.a.     n.a.
2459123.875000000, , , 280.513125605, -27.032895302,  280.831487016, -27.012723390,  15.17642,  1.818980,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.046, 18.953,   98.74763,   4.499268185373,  1.9115853,  4.36887664037423, 28.5585503,   91.0160,/T,   12.8508,   85.759, 271.961,    7.608992,-10.066638,    0.000000,           n.a.,   0.2547506,  83.165378,  64.775648,        n.a.     n.a.
2459123.916666667, , , 280.517862068, -27.032399055,  280.836217185, -27.012218230,  15.19534,  1.820811,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.046, 18.953,   98.74765,   4.499314181530,  1.9115162,  4.36956389463099, 28.5588893,   90.9794,/T,   12.8507,   85.760, 271.959,    7.611285,-10.070232,    0.000000,           n.a.,   0.2550673,  83.167001,  64.744975,        n.a.     n.a.
2459123.958333333, , , 280.522604411, -27.031902312,  280.840953230, -27.011712553,  15.21425,  1.822643,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.047, 18.954,   98.74768,   4.499360176024,  1.9114470,  4.37025115692697, 28.5592184,   90.9428,/T,   12.8505,   85.760, 271.957,    7.613580,-10.073831,    0.000000,           n.a.,   0.2553839,  83.168614,  64.714313,        n.a.     n.a.
2459124.000000000, , , 280.527352629, -27.031405070,  280.845695147, -27.011206359,  15.23315,  1.824475,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.047, 18.954,   98.74771,   4.499406168854,  1.9113779,  4.37093842702114, 28.5595374,   90.9062,/T,   12.8504,   85.761, 271.954,    7.615879,-10.077434,    0.000000,           n.a.,   0.2557004,  83.170218,  64.683663,        n.a.     n.a.
2459124.041666667, , , 280.532106720, -27.030907331,  280.850442936, -27.010699648,  15.25205,  1.826307,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.047, 18.955,   98.74775,   4.499452160021,  1.9113088,  4.37162570467259, 28.5598465,   90.8696,/T,   12.8502,   85.762, 271.952,    7.618180,-10.081042,    0.000000,           n.a.,   0.2560167,  83.171812,  64.653025,        n.a.     n.a.
2459124.083333333, , , 280.536866683, -27.030409094,  280.855196593, -27.010192418,  15.27094,  1.828141,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.048, 18.955,   98.74778,   4.499498149525,  1.9112397,  4.37231298964051, 28.5601455,   90.8330,/T,   12.8500,   85.762, 271.950,    7.620483,-10.084655,    0.000000,           n.a.,   0.2563329,  83.173397,  64.622398,        n.a.     n.a.
2459124.125000000, , , 280.541632513, -27.029910359,  280.859956116, -27.009684672,  15.28982,  1.829974,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.048, 18.955,   98.74781,   4.499544137365,  1.9111705,  4.37300028168408, 28.5604345,   90.7964,/T,   12.8499,   85.763, 271.948,    7.622790,-10.088272,    0.000000,           n.a.,   0.2566490,  83.174973,  64.591783,        n.a.     n.a.
2459124.166666667, , , 280.546404209, -27.029411126,  280.864721503, -27.009176407,  15.30869,  1.831808,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.049, 18.956,   98.74785,   4.499590123542,  1.9111014,  4.37368758056265, 28.5607135,   90.7598,/T,   12.8497,   85.764, 271.946,    7.625099,-10.091894,    0.000000,           n.a.,   0.2569649,  83.176540,  64.561179,        n.a.     n.a.
2459124.208333333, , , 280.551181768, -27.028911394,  280.869492752, -27.008667625,  15.32755,  1.833643,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.049, 18.956,   98.74788,   4.499636108054,  1.9110322,  4.37437488603562, 28.5609826,   90.7232,/T,   12.8495,   85.764, 271.944,    7.627410,-10.095520,    0.000000,           n.a.,   0.2572807,  83.178097,  64.530587,        n.a.     n.a.
2459124.250000000, , , 280.555965186, -27.028411164,  280.874269860, -27.008158324,  15.34640,  1.835478,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.049, 18.956,   98.74792,   4.499682090903,  1.9109631,  4.37506219786249, 28.5612416,   90.6866,/T,   12.8493,   85.765, 271.941,    7.629725,-10.099151,    0.000000,           n.a.,   0.2575963,  83.179645,  64.500007,        n.a.     n.a.
2459124.291666667, , , 280.560754462, -27.027910435,  280.879052825, -27.007648505,  15.36525,  1.837313,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.050, 18.957,   98.74796,   4.499728072088,  1.9108940,  4.37574951580278, 28.5614907,   90.6500,/T,   12.8491,   85.765, 271.939,    7.632041,-10.102787,    0.000000,           n.a.,   0.2579118,  83.181184,  64.469438,        n.a.     n.a.
2459124.333333333, , , 280.565549593, -27.027409208,  280.883841645, -27.007138168,  15.38409,  1.839149,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.050, 18.957,   98.74799,   4.499774051609,  1.9108248,  4.37643683961613, 28.5617297,   90.6134,/T,   12.8489,   85.766, 271.937,    7.634361,-10.106427,    0.000000,           n.a.,   0.2582272,  83.182714,  64.438880,        n.a.     n.a.
2459124.375000000, , , 280.570350576, -27.026907482,  280.888636317, -27.006627312,  15.40292,  1.840985,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.051, 18.957,   98.74803,   4.499820029466,  1.9107556,  4.37712416906225, 28.5619588,   90.5769,/T,   12.8487,   85.767, 271.935,    7.636683,-10.110072,    0.000000,           n.a.,   0.2585424,  83.184234,  64.408334,        n.a.     n.a.
2459124.416666667, , , 280.575157408, -27.026405256,  280.893436839, -27.006115938,  15.42174,  1.842822,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.051, 18.958,   98.74807,   4.499866005659,  1.9106865,  4.37781150390094, 28.5621779,   90.5403,/T,   12.8485,   85.767, 271.933,    7.639008,-10.113721,    0.000000,           n.a.,   0.2588575,  83.185746,  64.377799,        n.a.     n.a.
2459124.458333333, , , 280.579970087, -27.025902532,  280.898243209, -27.005604045,  15.44055,  1.844659,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.051, 18.958,   98.74812,   4.499911980187,  1.9106173,  4.37849884389201, 28.5623870,   90.5037,/T,   12.8483,   85.768, 271.931,    7.641336,-10.117375,    0.000000,           n.a.,   0.2591725,  83.187248,  64.347276,        n.a.     n.a.
2459124.500000000, , , 280.584788610, -27.025399308,  280.903055425, -27.005091633,  15.45935,  1.846497,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,   19.052, 18.958,   98.74816,   4.499957953051,  1.9105481,  4.37918618879540, 28.5625862,   90.4672,/T,   12.8481,   85.769, 271.928,    7.643666,-10.121033,    0.000000,           n.a.,   0.2594873,  83.188742,  64.316764,        n.a.     n.a.
$$EOE
)";

      const string table_obs = R"(
*******************************************************************************
Ephemeris / WWW_USER Fri Mar 24 06:06:35 2023 Pasadena, USA      / Horizons    
*******************************************************************************
Target body name: 74P/Smirnova-Chernykh           {source: JPL#K183/41}
Center body name: Earth (399)                     {source: DE441}
Center-site name: Mauna Kea
*******************************************************************************
Start time      : A.D. 2020-Oct-01 00:00:00.0000 UT      
Stop  time      : A.D. 2020-Oct-02 00:00:00.0000 UT      
Step-size       : 60 minutes
*******************************************************************************
Target pole/equ : undefined
Target radii    : 2.23 km                                                      
Center geodetic : 204.5278, 19.8260847, 4.21024   {E-lon(deg),Lat(deg),Alt(km)}
Center cylindric: 204.5278, 6006.35451, 2151.0229 {E-lon(deg),Dxy(km),Dz(km)}
Center pole/equ : ITRF93                          {East-longitude positive}
Center radii    : 6378.137, 6378.137, 6356.752 km {Equator_a, b, pole_c}       
Target primary  : Sun
Vis. interferer : MOON (R_eq= 1737.400) km        {source: DE441}
Rel. light bend : Sun                             {source: DE441}
Rel. lght bnd GM: 1.3271E+11 km^3/s^2                                          
Small-body perts: Yes                             {source: SB441-N16}
Atmos refraction: NO (AIRLESS)
RA format       : DEG
Time format     : JD  
Calendar mode   : Mixed Julian/Gregorian
EOP file        : eop.230322.p230615                                           
EOP coverage    : DATA-BASED 1962-JAN-20 TO 2023-MAR-22. PREDICTS-> 2023-JUN-14
Units conversion: 1 au= 149597870.700 km, c= 299792.458 km/s, 1 day= 86400.0 s 
Table cut-offs 1: Elevation (-90.0deg=NO ),Airmass (>38.000=NO), Daylight (NO )
Table cut-offs 2: Solar elongation (  0.0,180.0=NO ),Local Hour Angle( 0.0=NO )
Table cut-offs 3: RA/DEC angular rate (     0.0=NO )                           
Table format    : Comma Separated Values (spreadsheet)
*******************************************************************************
Initial IAU76/J2000 heliocentric ecliptic osculating elements (au, days, deg.):
  EPOCH=  2456199.5 ! 2012-Sep-29.0000000 (TDB)    RMSW= n.a.                  
   EC= .1476581394100441   QR= 3.550719336771267   TP= 2455039.2047568592      
   OM= 77.08403534654171   W= 86.5924648418255     IN= 6.651025247302388       
  Equivalent ICRF heliocentric cartesian coordinates (au, au/d):
   X= 2.881257535953767E+00  Y=-3.142809987884802E+00  Z=-1.822004029378378E+00
  VX= 6.253668570706597E-03 VY= 4.037724524377757E-03 VZ= 1.093469058340452E-03
Comet physical (GM= km^3/s^2; RAD= km):                                        
   GM= n.a.                RAD= 2.23                                           
   M1=  6.7      M2=  12.1     k1=  14.    k2=  5.      PHCOF=  .030           
Comet non-gravitational force model (AMRAT=m^2/kg;A1-A3=au/d^2;DT=days;R0=au): 
   AMRAT=  0.                                      DT=  0.                     
   A1= 2.011297035217E-7   A2= -9.918458938599E-8  A3= 0.                      
 Standard model:                                                               
   ALN=  .1112620426   NK=  4.6142   NM=  2.15     NN=  5.093    R0=  2.808    
**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
Date_________JDUT, , , R.A.___(ICRF), DEC____(ICRF),  R.A.__(a-app), DEC___(a-app),  dRA*cosD, d(DEC)/dt, Azimuth_(a-app), Elevation_(a-app),  L_Ap_Sid_Time,  a-mass, mag_ex,    T-mag,  N-mag,      Illu%,                r,       rdot,             delta,     deldot,     S-O-T,/r,     S-T-O,    PsAng,   PsAMV,      GlxLon,    GlxLat,  399_ins_LT,  L_Ap_Hour_Ang,  Sky_motion, Sky_mot_PA, RelVel-ANG,  Lun_Sky_Brt, sky_SNR,
**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
$$SOE
2459123.500000000,*, , 280.471302913, -27.037605563,  280.789759480, -27.017477211,  14.80341,  1.595797,   124.027894607,      10.705314653,  14.3141162690,   5.204,  0.567,   19.042, 18.950,   98.74751,   4.498854145181,  1.9122072,  4.36268378112256, 28.1984765,   91.3467,/T,   12.8513,   85.751, 271.980,    7.588487,-10.035063,    0.000355,   -4.405201030,   0.2481529,  83.847315,  65.104753,         n.a.,    n.a.,
2459123.541666667,*, , 280.475905342, -27.037167057,  280.794376777, -27.017035320,  14.71126,  1.628583,   131.704559575,      21.892822543,  15.3168540765,   2.662,  0.290,   19.043, 18.950,   98.74751,   4.498900156354,  1.9121381,  4.36336296615753, 28.2521468,   91.3105,/T,   12.8513,   85.752, 271.978,    7.590679,-10.038592,    0.000355,   -3.402771042,   0.2466855,  83.682898,  65.272296,         n.a.,    n.a.,
2459123.583333333,*, , 280.480482211, -27.036717664,  280.798964438, -27.016584609,  14.64059,  1.673398,   142.059691769,      31.594438356,  16.3195918837,   1.902,  0.207,   19.043, 18.951,   98.74751,   4.498946165855,  1.9120690,  4.36404370140604, 28.3265788,   91.2741,/T,   12.8513,   85.752, 271.976,    7.592867,-10.042094,    0.000355,   -2.400339079,   0.2455986,  83.479473,  65.421970,         n.a.,    n.a.,
2459123.625000000,*, , 280.485041228, -27.036254452,  280.803529006, -27.016121634,  14.59755,  1.727297,   155.802619881,      38.940280784,  17.3223296908,   1.588,  0.173,   19.043, 18.951,   98.74751,   4.498992173680,  1.9119999,  4.36472642804576, 28.4167044,   91.2376,/T,   12.8513,   85.753, 271.974,    7.595058,-10.045573,    0.000355,   -1.397905576,   0.2449898,  83.251690,  65.541001,         n.a.,    n.a.,
2459123.666666667,*,m, 280.489591725, -27.035775399,  280.808079003, -27.015643757,  14.58636,  1.786710,   172.790445894,      42.806788050,  18.3250674977,   1.469,  0.160,   19.044, 18.951,   98.74751,   4.499038179829,  1.9119308,  4.36541145157329, 28.5163801,   91.2010,/T,   12.8513,   85.754, 271.972,    7.597257,-10.049033,    0.000355,   -0.395471102,   0.2449230,  83.016524,  65.619012,         n.a.,    n.a.,
2459123.708333333,A,m, 280.494144019, -27.035279536,  280.812624350, -27.015149325,  14.60909,  1.847693,   190.993636758,      42.334965749,  19.3278053044,   1.482,  0.162,   19.044, 18.952,   98.74750,   4.499084184299,  1.9118617,  4.36609892086551, 28.6188075,   91.1642,/T,   12.8513,   85.755, 271.969,    7.599469,-10.052482,    0.000355,    0.606963681,   0.2454245,  82.791756,  65.648785,        2.261,   8.381,
2459123.750000000, ,m, 280.498708701, -27.034767010,  280.817175687, -27.014637785,  14.66546,  1.906194,   207.396384750,      37.642422228,  20.3305431110,   1.634,  0.178,   19.045, 18.952,   98.74750,   4.499130187090,  1.9117926,  4.36678881796635, 28.7169993,   91.1272,/T,   12.8514,   85.755, 271.967,    7.601699,-10.055929,    0.000355,    1.609398065,   0.2464804,  82.594300,  65.626691,        2.465,   7.687,
2459123.791666667, ,m, 280.503295917, -27.034239077,  280.821743644, -27.014109718,  14.75291,  1.958336,   220.390043938,      29.711131292,  21.3332809175,   2.010,  0.219,   19.045, 18.952,   98.74750,   4.499176188205,  1.9117235,  4.36748095929894, 28.8042573,   91.0902,/T,   12.8514,   85.756, 271.965,    7.603951,-10.059383,    0.000355,    2.611831341,   0.2480386,  82.438628,  65.552809,        2.579,   7.349,
2459123.833333333, ,m, 280.507914669, -27.033698010,  280.826338111, -27.013566803,  14.86672,  2.000674,   230.114052647,      19.635382899,  22.3360187238,   2.947,  0.321,   19.045, 18.953,   98.74751,   4.499222187645,  1.9116544,  4.36817500822000, 28.8746315,   91.0531,/T,   12.8513,   85.757, 271.963,    7.606226,-10.062851,    0.000355,    3.614262850,   0.2500123,  82.335528,  65.430735,        2.681,   7.069,
2459123.875000000, ,m, 280.512572199, -27.033146950,  280.830967564, -27.013011697,  15.00041,  2.030439,   237.325735986,       8.214416254,  23.3387565302,   6.615,  0.721,   19.046, 18.953,   98.74753,   4.499268185412,  1.9115853,  4.36887049805668, 28.9233272,   91.0159,/T,   12.8513,   85.758, 271.961,    7.608526,-10.066343,    0.000355,    4.616692026,   0.2522867,  82.291359,  65.267177,        2.834,   6.687,
2459123.916666667, ,m, 280.517273496, -27.032589685,  280.835638484, -27.012447858,  15.14610,  2.045723,   242.710427005,      -4.049109797,   0.3414943365,    n.a.,   n.a.,   19.046, 18.953,   98.74755,   4.499314181511,  1.9115162,  4.36956686404764, 28.9470339,   90.9787,/T,   12.8512,   85.759, 271.959,    7.610850,-10.069864,    0.000355,    5.619118438,   0.2547271,  82.307840,  65.071374,         n.a.,    n.a.,
2459123.958333333, ,m, 280.522020951, -27.032030393,  280.840354912, -27.011879302,  15.29511,  2.045610,   246.717388224,     -16.846921728,   1.3442321427,    n.a.,   n.a.,   19.047, 18.954,   98.74758,   4.499360175945,  1.9114470,  4.37026348200108, 28.9441512,   90.9416,/T,   12.8511,   85.760, 271.957,    7.613196,-10.073420,    0.000355,    6.621541815,   0.2571882,  82.382309,  64.854437,         n.a.,    n.a.,
2459124.000000000, ,m, 280.526814199, -27.031473355,  280.845118175, -27.011310335,  15.43853,  2.030239,   249.551571773,     -29.981739014,   2.3469699489,    n.a.,   n.a.,   19.047, 18.954,   98.74762,   4.499406168719,  1.9113779,  4.37095971102154, 28.9148992,   90.9045,/T,   12.8509,   85.761, 271.955,    7.615560,-10.077014,    0.000355,    7.623962071,   0.2595242,  82.508324,  64.628638,         n.a.,    n.a.,
2459124.041666667, ,m, 280.531650141, -27.030922662,  280.849926798, -27.010745250,  15.56784,  2.000794,   251.119599718,     -43.311332125,   3.3497077551,    n.a.,   n.a.,   19.047, 18.955,   98.74767,   4.499452159835,  1.9113088,  4.37165493737986, 28.8613028,   90.8675,/T,   12.8507,   85.762, 271.952,    7.617938,-10.080646,    0.000355,    8.626379302,   0.2615981,  82.676436,  64.406692,         n.a.,    n.a.,
2459124.083333333, ,m, 280.536523158, -27.030381935,  280.854776600, -27.010188040,  15.67548,  1.959421,   250.704334667,     -56.696884915,   4.3524455613,    n.a.,   n.a.,   19.048, 18.955,   98.74772,   4.499498149298,  1.9112397,  4.37234861652211, 28.7870530,   90.8306,/T,   12.8504,   85.763, 271.950,    7.620325,-10.084315,    0.000355,    9.628793788,   0.2632912,  82.875035,  64.201047,         n.a.,    n.a.,
2459124.125000000,A,m, 280.541425497, -27.029854077,  280.859660988, -27.009642121,  15.75539,  1.909083,   245.221196317,     -69.869408918,   5.3551833676,    n.a.,   n.a.,   19.048, 18.955,   98.74778,   4.499544137110,  1.9111705,  4.37304031034103, 28.6972547,   90.7938,/T,   12.8501,   85.763, 271.948,    7.622715,-10.088016,    0.000355,   10.631205968,   0.2645106,  83.091145,  64.023183,         n.a.,    n.a.,
2459124.166666667,C,m, 280.546347802, -27.029341076,  280.864571401, -27.009110101,  15.80340,  1.853354,   214.015438899,     -81.226553788,   6.3579211740,    n.a.,   n.a.,   19.049, 18.956,   98.74784,   4.499590123273,  1.9111014,  4.37372971715852, 28.5980766,   90.7572,/T,   12.8498,   85.764, 271.946,    7.625101,-10.091745,    0.000355,   11.633616414,   0.2651951,  83.311154,  63.882947,         n.a.,    n.a.,
2459124.208333333,*, , 280.551279754, -27.028843866,  280.869497905, -27.008593598,  15.81752,  1.796177,   131.186247732,     -78.684251736,   7.3606589804,    n.a.,   n.a.,   19.049, 18.956,   98.74790,   4.499636107788,  1.9110322,  4.37441669236627, 28.4963289,   90.7208,/T,   12.8495,   85.764, 271.944,    7.627480,-10.095493,    0.000355,  -11.363974213,   0.2653195,  83.521462,  63.787926,         n.a.,    n.a.,
2459124.250000000,*, , 280.556210780, -27.028362268,  280.874429866, -27.008093134,  15.79808,  1.741592,   112.355999941,     -66.380252801,   8.3633967869,    n.a.,   n.a.,   19.049, 18.956,   98.74796,   4.499682090654,  1.9109631,  4.37510125831169, 28.3989972,   90.6845,/T,   12.8492,   85.765, 271.941,    7.629846,-10.099252,    0.000355,  -10.361565204,   0.2648964,  83.709073,  63.742901,         n.a.,    n.a.,
2459124.291666667,*, , 280.561130772, -27.027894998,  280.879356682, -27.007608096,  15.74772,  1.693461,   108.891942635,     -53.101054790,   9.3661345935,    n.a.,   n.a.,   19.050, 18.957,   98.74802,   4.499728071871,  1.9108940,  4.37578360275233, 28.3127642,   90.6483,/T,   12.8489,   85.765, 271.939,    7.632196,-10.103014,    0.000355,   -9.359155852,   0.2639752,  83.862176,  63.749419,         n.a.,    n.a.,
2459124.333333333,*, , 280.566030784, -27.027439759,  280.884268508, -27.007136780,  15.67119,  1.655203,   109.150201991,     -39.713751136,  10.3688724003,    n.a.,   n.a.,   19.050, 18.957,   98.74808,   4.499774051435,  1.9108248,  4.37646406598469, 28.2435519,   90.6122,/T,   12.8486,   85.766, 271.937,    7.634527,-10.106770,    0.000355,   -8.356745500,   0.2626393,  83.970730,  63.805532,         n.a.,    n.a.,
2459124.375000000,*, , 280.570903642, -27.026993397,  280.889156927, -27.006676509,  15.57502,  1.629558,   111.091695907,     -26.423416150,  11.3716102072,    n.a.,   n.a.,   19.051, 18.957,   98.74813,   4.499820029345,  1.9107556,  4.37714311752812, 28.1961161,   90.5762,/T,   12.8483,   85.766, 271.935,    7.636839,-10.110512,    0.000355,   -7.354333588,   0.2610005,  84.027079,  63.905774,         n.a.,    n.a.,
2459124.416666667,*, , 280.575744432, -27.026552115,  280.894015530, -27.006223815,  15.46709,  1.618405,   114.235273212,     -13.363157316,  12.3743480144,    n.a.,   n.a.,   19.051, 18.958,   98.74817,   4.499866005596,  1.9106865,  4.37782132396019, 28.1737212,   90.5402,/T,   12.8480,   85.766, 271.933,    7.639133,-10.114233,    0.000355,   -6.351919688,   0.2591922,  84.026570,  64.041394,         n.a.,    n.a.,
2459124.458333333,*, , 280.580550839, -27.026111737,  280.898840349, -27.005774677,  15.35609,  1.622628,   118.581801169,      -0.685330795,  13.3770858216,    n.a.,   n.a.,   19.051, 18.958,   98.74821,   4.499911980184,  1.9106173,  4.37849931010514, 28.1779159,   90.5042,/T,   12.8478,   85.767, 271.930,    7.641410,-10.117929,    0.000355,   -5.349503535,   0.2573597,  83.968125,  64.200907,         n.a.,    n.a.,
2459124.500000000,*, , 280.585323302, -27.025667993,  280.903630132, -27.005324794,  15.25090,  1.642058,   124.402783921,      11.389380564,  14.3798236291,   4.914,  0.535,   19.052, 18.958,   98.74825,   4.499957953105,  1.9105481,  4.37917771623301, 28.2084276,   90.4681,/T,   12.8476,   85.767, 271.928,    7.643674,-10.121596,    0.000355,   -4.347085046,   0.2556507,  83.854662,  64.370901,         n.a.,    n.a.,
$$EOE
    )";

      const Ephemeris eph_geo = horizons_to_ephemeris(table_geo);
      const Ephemeris eph_obs = horizons_to_ephemeris(table_obs);
      const Observatory obs{204.5278, 0.94171, +0.33725}; // Mauna Kea (568)
      for (int i = 0; i < eph_obs.num_vertices(); i++)
      {
        S2LatLng coords_geo = eph_geo.data(i).as_s2latlng();
        S2LatLng coords_obs = eph_obs.data(i).as_s2latlng();
        S2LatLng coords = obs.parallax(coords_geo, eph_geo.data(i).mjd, eph_geo.data(i).delta);
        EXPECT_NEAR(coords.lng().radians(), coords_obs.lng().radians(), 0.01 * ARCSEC);
        EXPECT_NEAR(coords.lat().radians(), coords_obs.lat().radians(), 0.01 * ARCSEC);
      }
    }

    TEST(ObservatoryTests, ObservatoryMoonParallax)
    {
      const string table_obs = R"(
*******************************************************************************
 Revised: July 31, 2013             Moon / (Earth)                          301
 
 GEOPHYSICAL DATA (updated 2018-Aug-15):
  Vol. mean radius, km  = 1737.53+-0.03    Mass, x10^22 kg       =    7.349
  Radius (gravity), km  = 1738.0           Surface emissivity    =    0.92
  Radius (IAU), km      = 1737.4           GM, km^3/s^2          = 4902.800066
  Density, g/cm^3       =    3.3437        GM 1-sigma, km^3/s^2  =  +-0.0001  
  V(1,0)                =   +0.21          Surface accel., m/s^2 =    1.62
  Earth/Moon mass ratio = 81.3005690769    Farside crust. thick. = ~80 - 90 km
  Mean crustal density  = 2.97+-.07 g/cm^3 Nearside crust. thick.= 58+-8 km 
  Heat flow, Apollo 15  = 3.1+-.6 mW/m^2   Mean angular diameter = 31'05.2"
  Heat flow, Apollo 17  = 2.2+-.5 mW/m^2   Sid. rot. rate, rad/s = 0.0000026617
  Geometric Albedo      = 0.12             Mean solar day        = 29.5306 d
  Obliquity to orbit    = 6.67 deg         Orbit period          = 27.321582 d
  Semi-major axis, a    = 384400 km        Eccentricity          = 0.05490
  Mean motion, rad/s    = 2.6616995x10^-6  Inclination           = 5.145 deg
  Apsidal period        = 3231.50 d        Nodal period          = 6798.38 d
                                 Perihelion  Aphelion    Mean
  Solar Constant (W/m^2)         1414+-7     1323+-7     1368+-7
  Maximum Planetary IR (W/m^2)   1314        1226        1268
  Minimum Planetary IR (W/m^2)      5.2         5.2         5.2
********************************************************************************


*******************************************************************************
Ephemeris / WWW_USER Fri Mar 24 09:34:18 2023 Pasadena, USA      / Horizons    
*******************************************************************************
Target body name: Moon (301)                      {source: DE441}
Center body name: Earth (399)                     {source: DE441}
Center-site name: Cerro Paranal
*******************************************************************************
Start time      : A.D. 2020-Oct-01 00:00:00.0000 UT      
Stop  time      : A.D. 2020-Oct-02 00:00:00.0000 UT      
Step-size       : 60 minutes
*******************************************************************************
Target pole/equ : MOON_ME                         {East-longitude positive}
Target radii    : 1737.4, 1737.4, 1737.4 km       {Equator_a, b, pole_c}       
Center geodetic : 289.5957, -24.6272128, 2.63514  {E-lon(deg),Lat(deg),Alt(km)}
Center cylindric: 289.5957,5803.73915,-2642.69127 {E-lon(deg),Dxy(km),Dz(km)}
Center pole/equ : ITRF93                          {East-longitude positive}
Center radii    : 6378.137, 6378.137, 6356.752 km {Equator_a, b, pole_c}       
Target primary  : Earth
Vis. interferer : MOON (R_eq= 1737.400) km        {source: DE441}
Rel. light bend : Sun                             {source: DE441}
Rel. lght bnd GM: 1.3271E+11 km^3/s^2                                          
Atmos refraction: NO (AIRLESS)
RA format       : DEG
Time format     : JD  
Calendar mode   : Mixed Julian/Gregorian
EOP file        : eop.230322.p230615                                           
EOP coverage    : DATA-BASED 1962-JAN-20 TO 2023-MAR-22. PREDICTS-> 2023-JUN-14
Units conversion: 1 au= 149597870.700 km, c= 299792.458 km/s, 1 day= 86400.0 s 
Table cut-offs 1: Elevation (-90.0deg=NO ),Airmass (>38.000=NO), Daylight (NO )
Table cut-offs 2: Solar elongation (  0.0,180.0=NO ),Local Hour Angle( 0.0=NO )
Table cut-offs 3: RA/DEC angular rate (     0.0=NO )                           
Table format    : Comma Separated Values (spreadsheet)
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
Date_________JDUT, , , R.A.___(ICRF), DEC____(ICRF),  R.A.__(a-app), DEC___(a-app),  dRA*cosD, d(DEC)/dt, Azimuth_(a-app), Elevation_(a-app),  L_Ap_Sid_Time,  a-mass, mag_ex,    APmag,  S-brt,      Illu%,                r,       rdot,             delta,     deldot,     S-O-T,/r,     S-T-O,    PsAng,   PsAMV,      GlxLon,    GlxLat,  399_ins_LT,  L_Ap_Hour_Ang,  Sky_motion, Sky_mot_PA, RelVel-ANG, Lun_Sky_Brt  sky_SNR
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
$$SOE
2459123.500000000, ,m,   1.169274894,  -4.903107696,    1.435681210,  -4.787396317,  1280.691,  680.7534,    82.126711416,      27.700616480,  19.9853126506,   2.142,  0.302,  -12.358,  3.633,   99.22118,   1.003806418611, -0.3269916,  0.00267944334417, -0.3373316,  169.8518,/T,   10.1211,   37.488, 247.289,   94.250861,-65.136720,    0.000355,   -4.110399430,   24.172950,  62.007042,  -23.30443,        n.a.     n.a.
2459123.541666667, ,m,   1.503268096,  -4.712060411,    1.769646995,  -4.596359361,  1120.334,  695.0844,    73.866062059,      40.689028195,  20.9880504575,   1.531,  0.216,  -12.372,  3.625,   99.26899,   1.003798462528, -0.3342382,  0.00267201075153, -0.2766978,  170.1692,/T,    9.8046,   36.727, 247.257,   95.159776,-65.104145,    0.000355,   -3.129926009,   21.974045,  58.183461,  -21.29396,        n.a.     n.a.
2459123.583333333, ,m,   1.796906965,  -4.516767053,    2.063265146,  -4.401078442,  993.4960,  711.1077,    62.058437163,      53.027021802,  21.9907882643,   1.250,  0.176,  -12.385,  3.618,   99.31213,   1.003790331988, -0.3414908,  0.00266628594228, -0.1961650,  170.4645,/T,    9.5101,   36.129, 247.226,   95.983324,-65.046159,    0.000355,   -2.146762745,   20.362741,  54.406314,  -16.63646,        n.a.     n.a.
2459123.625000000, ,m,   2.060888126,  -4.316932614,    2.327229306,  -4.201257818,  909.3263,  727.5564,    42.150639965,      63.575716773,  22.9935260709,   1.116,  0.157,  -12.395,  3.611,   99.35193,   1.003782026854, -0.3487489,  0.00266268715845, -0.1009851,  170.7453,/T,    9.2301,   35.660, 247.197,   96.743330,-64.968024,    0.000355,   -1.161622550,   19.409423,  51.336529,  -9.177109,        n.a.     n.a.
2459123.666666667, ,m,   2.308051139,  -4.112616572,    2.574376322,  -3.996956904,  873.9984,  743.1612,     7.412513115,      69.214921943,  23.9962638773,   1.069,  0.151,  -12.403,  3.604,   99.38966,   1.003773546999, -0.3560120,  0.00266149238627,  0.0025054,  171.0194,/T,    8.9567,   35.267, 247.168,   97.466560,-64.875611,    0.000355,   -0.175361211,   19.120682,  49.625473,  0.2387758,        n.a.     n.a.
2459123.708333333, ,m,   2.552453372,  -3.904216008,    2.818761348,  -3.788573334,  890.0828,  756.7772,   328.739248833,      66.094313674,   0.9990016835,   1.093,  0.154,  -12.409,  3.598,   99.42644,   1.003764892305, -0.3632798,  0.00266281857186,  0.1073423,  171.2949,/T,    8.6820,   34.881, 247.140,   98.182520,-64.775011,    0.000355,    0.811084260,   19.471910,  49.627733,  9.7238106,        n.a.     n.a.
2459123.750000000, ,m,   2.808319762,  -3.692414631,    3.074607809,  -3.576791905,  956.2779,  767.4990,   304.767969478,      56.587415321,   2.0017394897,   1.197,  0.169,  -12.414,  3.591,   99.46322,   1.003756062666, -0.3705519,  0.00266661271066,  0.2064553,  171.5792,/T,    8.3984,   34.419, 247.113,   98.921068,-64.672081,    0.000355,    1.796765636,   20.436366,  51.249824,  17.406506,        n.a.     n.a.
2459123.791666667, ,m,   3.088975424,  -3.478103813,    3.355240131,  -3.362505555,  1067.547,  774.7441,   291.168548878,      44.577237002,   3.0044772956,   1.423,  0.201,  -12.416,  3.583,   99.50067,   1.003747057983, -0.3778278,  0.00267265574796,  0.2932011,  171.8789,/T,    8.0994,   33.790, 247.086,   99.710119,-64.571968,    0.000355,    2.780794620,   21.984124,  54.030733,  22.436710,        n.a.     n.a.
2459123.833333333, ,m,   3.405872236,  -3.262286355,    3.672110349,  -3.146719057,  1215.638,  778.2925,   282.216544263,      31.647617475,   4.0072151015,   1.900,  0.268,  -12.418,  3.575,   99.53914,   1.003737878170, -0.3851072,  0.00268057888269,  0.3618527,  172.1985,/T,    7.7805,   32.896, 247.061,  100.573633,-64.478665,    0.000355,    3.762407745,   24.057311,  57.371260,  24.905425,        n.a.     n.a.
2459123.875000000, ,m,   3.767803531,  -3.045976021,    4.034012741,  -2.930448482,  1389.886,  778.2779,   275.334063256,      18.369452113,   5.0099529074,   3.138,  0.443,  -12.420,  3.567,   99.57858,   1.003728523149, -0.3923895,  0.00268989059855,  0.4079948,  172.5403,/T,    7.4396,   31.635, 247.037,  101.530059,-64.394666,    0.000355,    4.741018725,   26.549224,  60.753011,  25.301314,        n.a.     n.a.
2459123.916666667,C,m,   4.180369021,  -2.830105424,    4.446548614,  -2.714628973,  1578.183,  775.1382,   269.300532166,       4.998276767,   6.0126907131,  10.042,  1.417,  -12.421,  3.558,   99.61852,   1.003718992850, -0.3996744,  0.00270001177987,  0.4287964,  172.9031,/T,    7.0776,   29.900, 247.014,  102.591254,-64.320767,    0.000355,    5.716254139,   29.304444,  63.841641,  24.153076,        n.a.     n.a.
2459123.958333333,*, ,   4.645713724,  -2.615452024,    4.911865051,  -2.500040588,  1767.957,  769.5380,   263.370869889,      -8.308985731,   7.0154285188,    n.a.,   n.a.,  -12.423,  3.548,   99.65815,   1.003709287217, -0.4069615,  0.00271031573842,  0.4231461,  173.2823,/T,    6.6994,   27.578, 246.993,  103.761905,-64.256051,    0.000355,    6.687970849,   32.136264,  66.477976,  21.900412,        n.a.     n.a.
2459124.000000000,*, ,   5.162529515,  -2.402587846,    5.428656249,  -2.287257784,  1947.068,  762.2779,   256.887008375,     -21.407224067,   8.0181663245,    n.a.,   n.a.,  -12.425,  3.539,   99.69635,   1.003699406201, -0.4142504,  0.00272016990085,  0.3916566,  173.6691,/T,    6.3136,   24.555, 246.974,  105.039388,-64.198070,    0.000355,    7.656255908,   34.849443,  68.619637,  18.875158,        n.a.     n.a.
2459124.041666667,*, ,   5.726282544,  -2.191854289,    5.992390741,  -2.076623964,  2104.534,  754.2068,   248.996197705,     -34.093777721,   9.0209041302,    n.a.,   n.a.,  -12.428,  3.529,   99.73183,   1.003689349762, -0.4215407,  0.00272897619882,  0.3365565,  174.0508,/T,    5.9329,   20.722, 246.956,  106.414024,-64.143181,    0.000355,    8.621411414,   37.259935,  70.283722,  15.318652,        n.a.     n.a.
2459124.083333333,*, ,   6.329616987,  -1.983360087,    6.595714963,  -1.868249144,  2231.077,  746.1447,   238.256329091,     -45.988267194,  10.0236419359,    n.a.,   n.a.,  -12.431,  3.520,   99.76332,   1.003679117873, -0.4288319,  0.00273620772513,  0.2614922,  174.4111,/T,    5.5735,   15.991, 246.941,  107.869691,-64.087005,    0.000355,    9.583927605,   39.208964,  71.508385,  11.405586,        n.a.     n.a.
2459124.125000000,*, ,   6.962884188,  -1.776998448,    7.228982251,  -1.662026824,  2319.490,  738.8217,   221.989404926,     -56.241962705,  11.0263797417,    n.a.,   n.a.,  -12.435,  3.512,   99.78968,   1.003668710515, -0.4361236,  0.00274143982084,  0.1712672,  174.7314,/T,    5.2540,   10.328, 246.927,  109.384756,-64.024943,    0.000355,   10.544447592,   40.571924,  72.331884,  7.2650508,        n.a.     n.a.
2459124.166666667,*, ,   7.614752896,  -1.572478686,    7.880862957,  -1.457665428,  2364.866,  732.8342,   196.537574427,     -62.934194765,  12.0291175475,    n.a.,   n.a.,  -12.440,  3.506,   99.81007,   1.003658127678, -0.4434155,  0.00274437432657,  0.0715381,  174.9932,/T,    4.9930,    3.789, 246.915,  110.933316,-63.952680,    0.000355,   11.503726684,   41.263505,  72.782625,  2.9971744,        n.a.     n.a.
2459124.208333333,*, ,   8.272866556,  -1.369367910,    8.539001662,  -1.254729894,  2364.716,  728.6150,   164.430107998,     -63.257636125,  13.0318553533,    n.a.,   n.a.,  -12.444,  3.501,   99.82409,   1.003647369366, -0.4507071,  0.00274485619757, -0.0315138,  175.1812,/L,    4.8056,  356.559, 246.904,  112.486695,-63.866617,    0.000355,  -11.537411424,   41.240361,  72.874918,  -1.313770,        n.a.     n.a.
2459124.250000000,*, ,   8.924523845,  -1.167139036,    9.190697656,  -1.052689727,  2319.025,  726.4161,   138.065925061,     -57.032742483,  14.0345931593,    n.a.,   n.a.,  -12.449,  3.498,   99.83179,   1.003636435588, -0.4579980,  0.00274288203033, -0.1315246,  175.2871,/L,    4.7000,  348.954, 246.895,  114.015150,-63.764187,    0.000355,  -10.578120018,   40.502260,  72.607253,  -5.588328,        n.a.     n.a.
2459124.291666667,*, ,   9.557365814,  -0.965222179,    9.823592044,  -0.850970581,  2230.250,  726.3005,   121.058823303,     -47.021356326,  15.0373309654,    n.a.,   n.a.,  -12.453,  3.497,   99.83366,   1.003625326367, -0.4652878,  0.00273860029640, -0.2222936,  175.3127,/L,    4.6745,  341.359, 246.888,  115.489698,-63.644020,    0.000355,   -9.617575171,   39.092223,  71.961704,  -9.741397,        n.a.     n.a.
2459124.333333333,*, ,  10.160055638,  -0.763057033,   10.426347497,  -0.649006969,  2103.265,  728.1420,   109.845118991,     -35.270355052,  16.0400687716,    n.a.,   n.a.,  -12.457,  3.499,   99.83061,   1.003614041733, -0.4725762,  0.00273230327193, -0.2981262,  175.2694,/L,    4.7178,  334.139, 246.883,  116.883955,-63.505954,    0.000355,   -8.655021062,   37.095647,  70.904346,  -13.67080,        n.a.     n.a.
2459124.375000000,*, ,  10.722934447,  -0.560143952,   10.989304104,  -0.446293793,  1945.241,  731.6341,   101.598022230,     -22.699871327,  17.0428065779,    n.a.,   n.a.,  -12.461,  3.501,   99.82384,   1.003602581728, -0.4798626,  0.00272441084313, -0.3541647,  175.1751,/L,    4.8119,  327.550, 246.880,  118.175866,-63.350910,    0.000355,   -7.689813696,   34.638015,  69.387973,  -17.24326,        n.a.     n.a.
2459124.416666667,*, ,  11.238629585,  -0.356091150,   11.505087676,  -0.242434067,  1765.420,  736.3090,    94.777306318,      -9.724663937,  18.0455443845,    n.a.,   n.a.,  -12.465,  3.504,   99.81465,   1.003590946404, -0.4871467,  0.00271544661514, -0.3866950,  175.0503,/L,    4.9364,  321.710, 246.880,  119.349203,-63.180648,    0.000355,   -6.721461461,   31.880242,  67.360302,  -20.27609,        n.a.     n.a.
2459124.458333333,C,m,  11.702581568,  -0.150654811,   11.969136794,  -0.037179574,  1574.746,  741.5699,    88.467196050,       3.428621319,  19.0482821912,  13.210,  1.864,  -12.469,  3.507,   99.80433,   1.003579135821, -0.4944282,  0.00270600709832, -0.3934117,  174.9138,/L,    5.0726,  316.620, 246.881,  120.394726,-62.997480,    0.000355,   -5.749660262,   29.010305,  64.783604,  -22.51347,        n.a.     n.a.
2459124.500000000, ,m,  12.113445824,   0.056231718,   12.380104677,   0.169539452,  1385.327,  746.7378,    81.955282625,      16.587534149,  20.0510199981,   3.455,  0.487,  -12.473,  3.511,   99.79393,   1.003567150051, -0.5017065,  0.00269672521260, -0.3736212,  174.7799,/L,    5.2061,  312.210, 246.884,  121.310911,-62.803964,    0.000355,   -4.774320314,   26.229485,  61.673846,  -23.59933,        n.a.     n.a.
$$EOE
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************)";

      const string table_geo = R"(
*******************************************************************************
Ephemeris / WWW_USER Fri Mar 24 09:27:53 2023 Pasadena, USA      / Horizons    
*******************************************************************************
Target body name: Moon (301)                      {source: DE441}
Center body name: Earth (399)                     {source: DE441}
Center-site name: GEOCENTRIC
*******************************************************************************
Start time      : A.D. 2020-Oct-01 00:00:00.0000 UT      
Stop  time      : A.D. 2020-Oct-02 00:00:00.0000 UT      
Step-size       : 60 minutes
*******************************************************************************
Target pole/equ : MOON_ME                         {East-longitude positive}
Target radii    : 1737.4, 1737.4, 1737.4 km       {Equator_a, b, pole_c}       
Center geodetic : 0.0, 0.0, -6378.137             {E-lon(deg),Lat(deg),Alt(km)}
Center cylindric: 0.0, 0.0, 0.0                   {E-lon(deg),Dxy(km),Dz(km)}
Center pole/equ : ITRF93                          {East-longitude positive}
Center radii    : 6378.137, 6378.137, 6356.752 km {Equator_a, b, pole_c}       
Target primary  : Earth
Vis. interferer : MOON (R_eq= 1737.400) km        {source: DE441}
Rel. light bend : Sun                             {source: DE441}
Rel. lght bnd GM: 1.3271E+11 km^3/s^2                                          
Atmos refraction: NO (AIRLESS)
RA format       : DEG
Time format     : JD  
Calendar mode   : Mixed Julian/Gregorian
EOP file        : eop.230322.p230615                                           
EOP coverage    : DATA-BASED 1962-JAN-20 TO 2023-MAR-22. PREDICTS-> 2023-JUN-14
Units conversion: 1 au= 149597870.700 km, c= 299792.458 km/s, 1 day= 86400.0 s 
Table cut-offs 1: Elevation (-90.0deg=NO ),Airmass (>38.000=NO), Daylight (NO )
Table cut-offs 2: Solar elongation (  0.0,180.0=NO ),Local Hour Angle( 0.0=NO )
Table cut-offs 3: RA/DEC angular rate (     0.0=NO )                           
Table format    : Comma Separated Values (spreadsheet)
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
Date_________JDUT, , , R.A.___(ICRF), DEC____(ICRF),  R.A.__(a-app), DEC___(a-app),  dRA*cosD, d(DEC)/dt, Azimuth_(a-app), Elevation_(a-app),  L_Ap_Sid_Time,  a-mass, mag_ex,    APmag,  S-brt,      Illu%,                r,       rdot,             delta,     deldot,     S-O-T,/r,     S-T-O,    PsAng,   PsAMV,      GlxLon,    GlxLat,  399_ins_LT,  L_Ap_Hour_Ang,  Sky_motion, Sky_mot_PA, RelVel-ANG, Lun_Sky_Brt  sky_SNR
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
$$SOE
2459123.500000000, , ,   0.441525105,  -5.243735775,    0.708003473,  -5.128024510,  1642.038,  731.3391,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.323,  3.650,   99.10720,   1.003806418633, -0.3269916,  0.00269953998944,  0.0201662,  169.1320,/T,   10.8388,   39.473, 247.360,   92.346575,-65.122055,    0.000000,           n.a.,   29.958972,  65.992520,  1.1873132,        n.a.     n.a.
2459123.541666667, , ,   0.899338654,  -5.040450320,    1.165744735,  -4.924741302,  1640.974,  732.2708,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.334,  3.640,   99.17282,   1.003798462560, -0.3342382,  0.00270002192699,  0.0198868,  169.5403,/T,   10.4315,   38.330, 247.320,   93.532679,-65.143851,    0.000000,           n.a.,   29.949104,  65.951583,  1.1711310,        n.a.     n.a.
2459123.583333333, , ,   1.356712753,  -4.836905023,    1.623052905,  -4.721205769,  1639.937,  733.1569,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.344,  3.631,   99.23530,   1.003790332027, -0.3414908,  0.00270049713588,  0.0196070,  169.9442,/T,   10.0287,   37.100, 247.282,   94.719923,-65.156258,    0.000000,           n.a.,   29.939350,  65.912300,  1.1549159,        n.a.     n.a.
2459123.625000000, , ,   1.813660791,  -4.633112573,    2.079941369,  -4.517430577,  1638.927,  733.9974,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.354,  3.621,   99.29462,   1.003782026899, -0.3487488,  0.00270096560518,  0.0193267,  170.3432,/T,    9.6307,   35.773, 247.246,   95.907472,-65.159272,    0.000000,           n.a.,   29.929712,  65.874670,  1.1386668,        n.a.     n.a.
2459123.666666667, , ,   2.270196171,  -4.429085616,    2.536423533,  -4.313428358,  1637.945,  734.7925,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.364,  3.611,   99.35080,   1.003773547046, -0.3560120,  0.00270142732339,  0.0190460,  170.7367,/T,    9.2383,   34.337, 247.212,   97.094489,-65.152899,    0.000000,           n.a.,   29.920188,  65.838691,  1.1223822,        n.a.     n.a.
2459123.708333333, , ,   2.726332314,  -4.224836762,    2.992512811,  -4.109211698,  1636.989,  735.5424,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.373,  3.602,   99.40383,   1.003764892352, -0.3632798,  0.00270188227846,  0.0187647,  171.1240,/T,    8.8521,   32.779, 247.179,   98.280142,-65.137154,    0.000000,           n.a.,   29.910779,  65.804361,  1.1060608,        n.a.     n.a.
2459123.750000000, , ,   3.182082651,  -4.020378579,    3.448222632,  -3.904793148,  1636.061,  736.2472,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.383,  3.592,   99.45370,   1.003756062710, -0.3705519,  0.00270233045781,  0.0184829,  171.5042,/T,    8.4729,   31.086, 247.148,   99.463600,-65.112065,    0.000000,           n.a.,   29.901484,  65.771679,  1.0897014,        n.a.     n.a.
2459123.791666667, , ,   3.637460624,  -3.815723599,    3.903566434,  -3.700185222,  1635.160,  736.9070,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.392,  3.583,   99.50043,   1.003747058021, -0.3778278,  0.00270277184823,  0.0182005,  171.8764,/T,    8.1017,   29.240, 247.119,  100.644047,-65.077668,    0.000000,           n.a.,   29.892304,  65.740643,  1.0733026,        n.a.     n.a.
2459123.833333333, , ,   4.092479688,  -3.610884315,    4.358557668,  -3.495400395,  1634.286,  737.5220,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.401,  3.574,   99.54401,   1.003737878199, -0.3851071,  0.00270320643600,  0.0179175,  172.2394,/T,    7.7396,   27.225, 247.091,  101.820676,-65.034011,    0.000000,           n.a.,   29.883239,  65.711252,  1.0568630,        n.a.     n.a.
2459123.875000000, , ,   4.547153305,  -3.405873185,    4.813209788,  -3.290451108,  1633.439,  738.0922,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.410,  3.566,   99.58444,   1.003728523167, -0.3923895,  0.00270363420678,  0.0176340,  172.5920,/T,    7.3879,   25.019, 247.065,  102.992701,-64.981150,    0.000000,           n.a.,   29.874288,  65.683504,  1.0403813,        n.a.     n.a.
2459123.916666667, , ,   5.001494948,  -3.200702631,    5.267536260,  -3.085349764,  1632.619,  738.6179,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.418,  3.557,   99.62173,   1.003718992856, -0.3996744,  0.00270405514568,  0.0173498,  172.9326,/T,    7.0482,   22.602, 247.041,  104.159352,-64.919152,    0.000000,           n.a.,   29.865451,  65.657398,  1.0238561,        n.a.     n.a.
2459123.958333333, , ,   5.455518095,  -2.995385039,    5.721550553,  -2.880108734,  1631.827,  739.0990,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.427,  3.549,   99.65587,   1.003709287209, -0.4069615,  0.00270446923722,  0.0170649,  173.2595,/T,    6.7223,   19.950, 247.019,  105.319885,-64.848093,    0.000000,           n.a.,   29.856729,  65.632932,  1.0072860,        n.a.     n.a.
2459124.000000000, , ,   5.909236228,  -2.789932764,    6.175266143,  -2.674740354,  1631.062,  739.5358,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.434,  3.541,   99.68686,   1.003699406179, -0.4142504,  0.00270487646532,  0.0167794,  173.5705,/T,    6.4121,   17.038, 246.999,  106.473580,-64.768056,    0.000000,           n.a.,   29.848122,  65.610104,  0.9906697,        n.a.     n.a.
2459124.041666667, , ,   6.362662840,  -2.584358125,    6.628696510,  -2.469256929,  1630.325,  739.9284,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.442,  3.534,   99.71471,   1.003689349729, -0.4215407,  0.00270527681335,  0.0164931,  173.8632,/T,    6.1201,   13.844, 246.980,  107.619746,-64.679137,    0.000000,           n.a.,   29.839629,  65.588914,  0.9740058,        n.a.     n.a.
2459124.083333333, , ,   6.815811422,  -2.378673409,    7.081855134,  -2.263670729,  1629.614,  740.2769,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.448,  3.527,   99.73942,   1.003679117829, -0.4288319,  0.00270567026406,  0.0162062,  174.1351,/T,    5.8490,   10.347, 246.963,  108.757724,-64.581434,    0.000000,           n.a.,   29.831251,  65.569359,  0.9572928,        n.a.     n.a.
2459124.125000000, , ,   7.268695470,  -2.172890873,    7.534755501,  -2.057993997,  1628.931,  740.5814,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.455,  3.521,   99.76099,   1.003668710463, -0.4361236,  0.00270605679962,  0.0159184,  174.3831,/T,    5.6017,    6.528, 246.947,  109.886886,-64.475058,    0.000000,           n.a.,   29.822988,  65.551439,  0.9405293,        n.a.     n.a.
2459124.166666667, , ,   7.721328482,  -1.967022741,    7.987411096,  -1.852238941,  1628.276,  740.8419,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.460,  3.515,   99.77941,   1.003658127622, -0.4434155,  0.00270643640161,  0.0156299,  174.6039,/T,    5.3815,    2.381, 246.933,  111.006639,-64.360123,    0.000000,           n.a.,   29.814840,  65.535152,  0.9237141,        n.a.     n.a.
2459124.208333333, , ,   8.173723958,  -1.761081211,    8.439835405,  -1.646417744,  1627.648,  741.0587,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.465,  3.511,   99.79470,   1.003647369309, -0.4507071,  0.00270680905101,  0.0153406,  174.7940,/L,    5.1919,  357.909, 246.921,  112.116425,-64.236751,    0.000000,           n.a.,   29.806807,  65.520496,  0.9068455,        n.a.     n.a.
2459124.250000000, , ,   8.625895396,  -1.555078448,    8.892041911,  -1.440542558,  1627.047,  741.2317,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.469,  3.507,   99.80686,   1.003636435534, -0.4579980,  0.00270717472822,  0.0150505,  174.9502,/L,    5.0361,  353.131, 246.911,  113.215723,-64.105071,    0.000000,           n.a.,   29.798889,  65.507471,  0.8899224,        n.a.     n.a.
2459124.291666667, , ,   9.077856295,  -1.349026592,    9.344044098,  -1.234625507,  1626.473,  741.3612,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.471,  3.504,   99.81588,   1.003625326319, -0.4652879,  0.00270753341304,  0.0147595,  175.0692,/L,    4.9175,  348.088, 246.903,  114.304049,-63.965214,    0.000000,           n.a.,   29.791087,  65.496075,  0.8729431,        n.a.     n.a.
2459124.333333333, , ,   9.529620150,  -1.142937753,    9.795855445,  -1.028678690,  1625.927,  741.4471,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.473,  3.502,   99.82176,   1.003614041695, -0.4725762,  0.00270788508466,  0.0144677,  175.1482,/L,    4.8387,  342.840, 246.896,  115.380959,-63.817320,    0.000000,           n.a.,   29.783402,  65.486307,  0.8559063,        n.a.     n.a.
2459124.375000000, , ,   9.981200456,  -0.936824016,   10.247489429,  -0.822714177,  1625.409,  741.4897,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.474,  3.501,   99.82452,   1.003602581702, -0.4798626,  0.00270822972170,  0.0141749,  175.1854,/L,    4.8016,  337.466, 246.891,  116.446044,-63.661531,    0.000000,           n.a.,   29.775832,  65.478165,  0.8388107,        n.a.     n.a.
2459124.416666667, , ,  10.432610700,  -0.730697442,   10.698959521,  -0.616744017,  1624.918,  741.4889,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.474,  3.501,   99.82415,   1.003590946393, -0.4871467,  0.00270856730217,  0.0138812,  175.1798,/L,    4.8072,  332.057, 246.887,  117.498935,-63.497991,    0.000000,           n.a.,   29.768379,  65.471648,  0.8216547,        n.a.     n.a.
2459124.458333333, , ,  10.883864370,  -0.524570066,   11.150279188,  -0.410780231,  1624.454,  741.4449,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.472,  3.502,   99.82066,   1.003579135826, -0.4944282,  0.00270889780349,  0.0135866,  175.1316,/L,    4.8553,  326.709, 246.885,  118.539299,-63.326851,    0.000000,           n.a.,   29.761043,  65.466756,  0.8044370,        n.a.     n.a.
2459124.500000000, , ,  11.334974944,  -0.318453897,   11.601461891,  -0.204834818,  1624.018,  741.3577,            n.a.,              n.a.,           n.a.,    n.a.,   n.a.,  -12.470,  3.504,   99.81404,   1.003567150072, -0.5017065,  0.00270922120249,  0.0132909,  175.0421,/L,    4.9446,  321.510, 246.885,  119.566841,-63.148263,    0.000000,           n.a.,   29.753824,  65.463487,  0.7871562,        n.a.     n.a.
$$EOE
************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************)";
      const Ephemeris eph_geo = horizons_to_ephemeris(table_geo);
      const Ephemeris eph_obs = horizons_to_ephemeris(table_obs);
      const Observatory obs{289.59569, 0.909943, -0.414336}; // Cerro Paranal (309)

      for (int i = 0; i < eph_obs.num_vertices(); i++)
      {
        S2LatLng coords_geo = eph_geo.data(i).as_s2latlng();
        S2LatLng coords_obs = eph_obs.data(i).as_s2latlng();
        S2LatLng coords = obs.parallax(coords_geo, eph_geo.data(i).mjd, eph_geo.data(i).delta);
        EXPECT_NEAR(coords.lng().radians(), coords_obs.lng().radians(), 8 * ARCSEC);
        EXPECT_NEAR(coords.lat().radians(), coords_obs.lat().radians(), 8 * ARCSEC);
      }
    }
  }
}